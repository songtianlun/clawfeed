<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Digest Dashboard</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚òÄÔ∏è</text></svg>">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { overflow-x: hidden; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; word-break: break-word; }
  .container { max-width: 900px; margin: 0 auto; padding: 20px; }
  h1 { font-size: 1.8em; margin-bottom: 8px; }
  @media (max-width: 480px) { h1 { font-size: 1.3em; } }
  .subtitle { color: #888; margin-bottom: 24px; }
  .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
  .tab { padding: 8px 16px; border-radius: 8px; background: #1a1a1a; border: 1px solid #333; cursor: pointer; color: #aaa; font-size: 14px; transition: all 0.2s; }
  .tab:hover { border-color: #555; color: #fff; }
  .tab.active { background: #2a2a2a; border-color: #666; color: #fff; }
  .digest-list { display: flex; flex-direction: column; gap: 16px; }
  .date-group { margin-bottom: 4px; }
  .date-group-header { font-size: 13px; color: #666; font-weight: 600; letter-spacing: 0.5px; padding: 8px 0 6px; border-bottom: 1px solid #1e1e1e; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .date-group-header .count { font-size: 11px; color: #444; font-weight: 400; }
  .date-group-items { display: flex; flex-direction: column; gap: 8px; }
  .digest-card { background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 14px 18px; cursor: pointer; transition: all 0.2s; display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
  .digest-card:hover { border-color: #444; background: #1e1e1e; }
  .digest-card .card-body { flex: 1; min-width: 0; }
  .digest-card .title { font-size: 14px; font-weight: 500; }
  .digest-card .excerpt { font-size: 12px; color: #666; margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }
  .digest-card .time-badge { font-size: 12px; color: #666; background: #141414; padding: 3px 10px; border-radius: 6px; border: 1px solid #222; white-space: nowrap; }
  .digest-viewer { display: none; background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 24px; margin-top: 16px; line-height: 1.7; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; font-size: 14px; max-height: 80vh; overflow-y: auto; overflow-x: hidden; }
  .digest-viewer a { color: #58a6ff; text-decoration: none; }
  .digest-viewer a:hover { text-decoration: underline; }
  .back-btn { display: inline-block; margin-bottom: 16px; padding: 6px 14px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #aaa; cursor: pointer; font-size: 13px; }
  .back-btn:hover { color: #fff; border-color: #666; }
  .empty { color: #555; text-align: center; padding: 40px; font-size: 14px; }
  .loading { color: #555; text-align: center; padding: 20px; }
  .mark-btn { display: inline-block; margin-left: 6px; padding: 1px 8px; font-size: 11px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; color: #f0b040; cursor: pointer; vertical-align: middle; transition: all .15s; text-decoration: none; }
  .mark-btn:hover { background: #3a3a1a; border-color: #f0b040; text-decoration: none; }
  .mark-btn.marked { color: #40c040; border-color: #40c040; cursor: default; }
  .mark-btn.disabled { color: #555; border-color: #333; cursor: pointer; opacity: .6; }
  .mark-btn.disabled:hover { background: #2a2a2a; border-color: #555; }
  .login-prompt { text-align: center; padding: 60px 20px; }
  .login-prompt .icon { font-size: 48px; margin-bottom: 16px; }
  .login-prompt .msg { color: #888; font-size: 15px; line-height: 1.6; margin-bottom: 20px; }
  .login-prompt .auth-btn { display: inline-block; padding: 10px 24px; font-size: 14px; }
  .login-banner { background: #1a1a1a; border: 1px solid #282828; border-radius: 10px; padding: 10px 16px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; font-size: 13px; color: #999; }
  .login-banner a { color: #58a6ff; text-decoration: none; }
  .login-banner a:hover { text-decoration: underline; }
  .login-banner .dismiss { cursor: pointer; color: #555; font-size: 16px; padding: 0 4px; line-height: 1; }
  .login-banner .dismiss:hover { color: #aaa; }
  .auth-bar { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .auth-tools { display: flex; align-items: center; gap: 6px; padding-left: 8px; border-left: 1px solid #333; margin-left: 2px; }
  .auth-bar img { width: 32px; height: 32px; border-radius: 50%; }
  .auth-bar .user-name { font-size: 13px; color: #aaa; }
  .auth-btn { padding: 6px 14px; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: #ccc; cursor: pointer; font-size: 13px; text-decoration: none; transition: all .2s; }
  .auth-btn:hover { border-color: #666; color: #fff; }
  .container { }
  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 8px; font-size: 13px; z-index: 999; opacity: 0; transition: opacity .3s; pointer-events: none; }
  .toast.show { opacity: 1; }
  .mark-card { background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 16px 20px; transition: all 0.2s; }
  .mark-card:hover { border-color: #444; background: #1e1e1e; }
  .mark-card .mark-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .mark-card .mark-date { font-size: 12px; color: #666; }
  .mark-card .mark-status { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
  .mark-card .mark-status.pending { background: #3a2a00; color: #f0b040; }
  .mark-card .mark-status.done { background: #0a2a0a; color: #40c040; }
  .mark-card .mark-author { font-size: 14px; font-weight: 600; color: #58a6ff; }
  .mark-card .mark-link { margin-top: 6px; }
  .mark-card .mark-link a { font-size: 12px; color: #666; text-decoration: none; word-break: break-all; }
  .mark-card .mark-link a:hover { color: #58a6ff; text-decoration: underline; }
  .mark-stats { display: flex; gap: 16px; margin-bottom: 16px; }
  .mark-stat { background: #1a1a1a; border: 1px solid #282828; border-radius: 8px; padding: 12px 16px; flex: 1; text-align: center; }
  .mark-stat .num { font-size: 24px; font-weight: 700; }
  .mark-stat .label { font-size: 12px; color: #888; margin-top: 2px; }
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;">
    <h1 style="margin:0">‚òÄÔ∏è AI Digest Dashboard</h1>
    <div class="auth-bar" id="authBar"></div>
  </div>
  <p class="subtitle"><span id="subtitleText">Kevin's AI news digest ‚Äî powered by Lisa</span></p>
  <div class="tabs">
    <div class="tab active" data-type="4h">4H ÁÆÄÊä•</div>
    <div class="tab" data-type="daily">Êó•Êä•</div>
    <div class="tab" data-type="weekly">Âë®Êä•</div>
    <div class="tab" data-type="monthly">ÊúàÊä•</div>
    <div class="tab" data-type="marks">üìå Mark Êî∂Ëóè</div>
  </div>
  <div id="loginBanner" class="login-banner" style="display:none;">
    <span>üí° ÁôªÂΩï Google Ë¥¶Âè∑Âç≥ÂèØÊî∂ËóèÊñáÁ´†„ÄÅÁÆ°ÁêÜ‰∏™‰∫∫‰π¶Á≠æ</span>
    <span style="display:flex;align-items:center;gap:10px;">
      <a href="#" id="bannerLogin">ÁôªÂΩï</a>
      <span class="dismiss" onclick="dismissBanner()">‚úï</span>
    </span>
  </div>
  <div id="list" class="digest-list"><div class="loading">‚è≥</div></div>
  <div id="viewer" class="digest-viewer"></div>
</div>
<div class="toast" id="toast"></div>

<script>
window.onerror = function(msg, src, line) {
  document.getElementById('list').innerHTML = '<div class="empty">JS Error: ' + msg + ' (line ' + line + ')</div>';
};

// ‚îÄ‚îÄ i18n ‚îÄ‚îÄ
const I18N = {
  zh: {
    title: '‚òÄÔ∏è AI Digest Dashboard',
    subtitle: 'AI Êñ∞ÈóªÁÆÄÊä• ‚Äî powered by Lisa',
    tab4h: '4H ÁÆÄÊä•', tabDaily: 'Êó•Êä•', tabWeekly: 'Âë®Êä•', tabMonthly: 'ÊúàÊä•', tabMarks: 'üìå Mark Êî∂Ëóè',
    loginBanner: 'üí° ÁôªÂΩï Google Ë¥¶Âè∑Âç≥ÂèØÊî∂ËóèÊñáÁ´†„ÄÅÁÆ°ÁêÜ‰∏™‰∫∫‰π¶Á≠æ',
    loginBtn: 'ÁôªÂΩï', logout: 'ÈÄÄÂá∫', signIn: 'Sign in with Google',
    loading: 'Âä†ËΩΩ‰∏≠...', noData: 'ÊöÇÊó†Êï∞ÊçÆ', loadMore: 'Âä†ËΩΩÊõ¥Â§ö', loadingMore: 'Âä†ËΩΩ‰∏≠...',
    loadFail: 'Âä†ËΩΩÂ§±Ë¥•', back: '‚Üê ËøîÂõûÂàóË°®', cantLoad: 'Êó†Ê≥ïÂä†ËΩΩ',
    today: '‰ªäÂ§©', yesterday: 'Êò®Â§©', articles: 'ÁØá',
    weekLabel: (y, w) => `üìÖ ${y} Á¨¨ ${w} Âë®`,
    monthLabel: (y, m) => `üìÖ ${y} Âπ¥ ${m} Êúà`,
    yearLabel: (y) => `üìÖ ${y} Âπ¥`,
    totalMarks: 'ÊÄª Mark', deepDived: 'Â∑≤ Deep Dive', pending: 'ÂæÖÂ§ÑÁêÜ',
    byTopic: 'üè∑Ô∏è ÊåâËØùÈ¢ò', byTime: 'üïê ÊåâÊó∂Èó¥',
    noMarks: 'ÊöÇÊó† Mark ËÆ∞ÂΩï', marksDone: '‚úÖ Â∑≤Ëß£ËØª', marksPending: '‚è≥ ÂæÖÂ§ÑÁêÜ',
    loginToMark: 'üîê ÁôªÂΩïÂêéÂèØÊî∂Ëóè',
    loginPromptTitle: 'ÁôªÂΩïÂêéÂèØ‰ΩøÁî®Êî∂ËóèÂäüËÉΩ',
    loginPromptDesc: 'Êî∂ËóèÊÑüÂÖ¥Ë∂£ÁöÑÂÜÖÂÆπÔºåÈöèÊó∂ÂõûÈ°æ',
    markSuccess: 'üìå Mark ÊàêÂäüÔºÅ', markDup: 'Â∑≤Áªè Mark Ëøá‰∫Ü', markFail: '‚ùå Mark Â§±Ë¥•',
    marked: '‚úÖ Â∑≤ Mark', mark: 'üìå Mark',
    items: 'Êù°', cannotLoadMarks: 'Êó†Ê≥ïÂä†ËΩΩ Marks Êï∞ÊçÆ',
    weekdays: ['Âë®Êó•','Âë®‰∏Ä','Âë®‰∫å','Âë®‰∏â','Âë®Âõõ','Âë®‰∫î','Âë®ÂÖ≠'],
  },
  en: {
    title: '‚òÄÔ∏è AI Digest Dashboard',
    subtitle: 'AI news digest ‚Äî powered by Lisa',
    tab4h: '4H Briefs', tabDaily: 'Daily', tabWeekly: 'Weekly', tabMonthly: 'Monthly', tabMarks: 'üìå Marks',
    loginBanner: 'üí° Sign in with Google to bookmark articles and manage your reading list',
    loginBtn: 'Login', logout: 'Logout', signIn: 'Sign in with Google',
    loading: 'Loading...', noData: 'No data', loadMore: 'Load More', loadingMore: 'Loading...',
    loadFail: 'Failed to load', back: '‚Üê Back', cantLoad: 'Cannot load',
    today: 'Today', yesterday: 'Yesterday', articles: 'articles',
    weekLabel: (y, w) => `üìÖ ${y} Week ${w}`,
    monthLabel: (y, m) => `üìÖ ${['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m]} ${y}`,
    yearLabel: (y) => `üìÖ ${y}`,
    totalMarks: 'Total', deepDived: 'Deep Dived', pending: 'Pending',
    byTopic: 'üè∑Ô∏è By Topic', byTime: 'üïê By Time',
    noMarks: 'No marks yet', marksDone: '‚úÖ Done', marksPending: '‚è≥ Pending',
    loginToMark: 'üîê Sign in to bookmark',
    loginPromptTitle: 'Sign in to use bookmarks',
    loginPromptDesc: 'Save interesting content and revisit anytime',
    markSuccess: 'üìå Marked!', markDup: 'Already marked', markFail: '‚ùå Mark failed',
    marked: '‚úÖ Marked', mark: 'üìå Mark',
    items: 'items', cannotLoadMarks: 'Cannot load marks',
    weekdays: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
  }
};

let lang = localStorage.getItem('digest_lang') || (navigator.language.startsWith('zh') ? 'zh' : 'en');
function t(key) { return I18N[lang]?.[key] ?? I18N.en[key] ?? key; }

function setLang(l) {
  lang = l;
  localStorage.setItem('digest_lang', l);
  applyLang();
  renderList();
}

function applyLang() {
  document.querySelector('h1').textContent = t('title');
  document.getElementById('subtitleText').textContent = t('subtitle');
  document.querySelector('[data-type="4h"]').textContent = t('tab4h');
  document.querySelector('[data-type="daily"]').textContent = t('tabDaily');
  document.querySelector('[data-type="weekly"]').textContent = t('tabWeekly');
  document.querySelector('[data-type="monthly"]').textContent = t('tabMonthly');
  document.querySelector('[data-type="marks"]').textContent = t('tabMarks');
  const banner = document.getElementById('loginBanner');
  if (banner) banner.querySelector('span').textContent = t('loginBanner');
  renderAuthBar();
}

// API base ‚Äî auto-detect: if served under /digest/, use /digest/api; otherwise /api
const API = (() => {
  if (location.pathname.startsWith('/digest')) return '/digest/api';
  return '/api';
})();

let currentUser = null;

async function checkAuth() {
  try {
    const r = await fetch(`${API}/auth/me`, { credentials: 'same-origin' });
    if (r.ok) {
      const data = await r.json();
      currentUser = data.user;
    }
  } catch {}
  renderAuthBar();
  updateMarkVisibility();
  if (currentUser && currentType === 'marks') renderMarks();
}

function ghLangHtml() {
  return `<span class="auth-tools"><a href="https://github.com/kevinho/ai-digest" target="_blank" style="text-decoration:none;line-height:0;display:flex;" title="GitHub"><svg height="16" width="16" viewBox="0 0 16 16" fill="#666" style="transition:fill .2s;" onmouseover="this.style.fill='#aaa'" onmouseout="this.style.fill='#666'"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><span id="langToggle" style="color:#666;cursor:pointer;font-size:12px;transition:color .2s;" onmouseover="this.style.color='#aaa'" onmouseout="this.style.color='#666'">${lang === 'zh' ? 'EN' : '‰∏≠Êñá'}</span></span>`;
}

function renderAuthBar() {
  const bar = document.getElementById('authBar');
  if (currentUser) {
    bar.innerHTML = `<img src="${currentUser.avatar}" alt="">`
      + `<span class="user-name">${currentUser.name}</span>`
      + `<a class="auth-btn" href="#" onclick="doLogout(); return false;">${t('logout')}</a>`
      + ghLangHtml();
  } else {
    bar.innerHTML = `<a class="auth-btn" href="${API}/auth/google?origin=${encodeURIComponent(location.origin)}">${t('signIn')}</a>`
      + ghLangHtml();
  }
  const lt = document.getElementById('langToggle');
  if (lt) lt.onclick = (e) => { e.preventDefault(); e.stopPropagation(); setLang(lang === 'zh' ? 'en' : 'zh'); };
}

function updateMarkVisibility() {
  // Always show marks tab ‚Äî show login prompt when clicked if not logged in
  // Show/hide login banner
  const banner = document.getElementById('loginBanner');
  if (banner) {
    if (!currentUser && !localStorage.getItem('digest_banner_dismissed')) {
      banner.style.display = '';
      document.getElementById('bannerLogin').href = `${API}/auth/google?origin=${encodeURIComponent(location.origin)}`;
    } else {
      banner.style.display = 'none';
    }
  }
}

function dismissBanner() {
  localStorage.setItem('digest_banner_dismissed', '1');
  document.getElementById('loginBanner').style.display = 'none';
}

async function doLogout() {
  await fetch(`${API}/auth/logout`, { method: 'POST', credentials: 'same-origin' });
  currentUser = null;
  renderAuthBar();
  updateMarkVisibility();
  if (currentType === 'marks') {
    renderList(); // Will show login prompt
  }
}

function WEEKDAYS() { return t('weekdays'); }
let currentType = '4h';
let markedUrls = new Set();
const PAGE_SIZE = 10;
let currentOffset = 0;
let allLoaded = false;

function parseCreatedAt(d) {
  const ca = d.created_at;
  // Handle week format: "2026-W07"
  if (/^\d{4}-W\d{2}$/.test(ca)) {
    const [y, w] = ca.split('-W').map(Number);
    // Approximate: week 1 starts Jan 1
    const jan1 = new Date(y, 0, 1);
    return new Date(jan1.getTime() + (w - 1) * 7 * 86400000);
  }
  // Handle month format: "2026-02"
  if (/^\d{4}-\d{2}$/.test(ca)) {
    return new Date(ca + '-01T00:00:00+08:00');
  }
  // Handle year format: "2026"
  if (/^\d{4}$/.test(ca)) {
    return new Date(ca + '-01-01T00:00:00+08:00');
  }
  return new Date(ca.replace(' ', 'T') + (ca.includes('+') ? '' : '+08:00'));
}

function getWeekKey(dt) {
  const d = new Date(dt); d.setHours(0,0,0,0);
  const jan1 = new Date(d.getFullYear(), 0, 1);
  const days = Math.floor((d - jan1) / 86400000);
  const week = Math.ceil((days + jan1.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${String(week).padStart(2, '0')}`;
}

function groupDigests(digests) {
  const groups = {}; const order = [];
  for (const d of digests) {
    const dt = parseCreatedAt(d);
    let key;
    if (currentType === '4h') {
      key = dt.toISOString().slice(0, 10); // by day
    } else if (currentType === 'daily') {
      key = getWeekKey(dt); // by week
    } else if (currentType === 'weekly') {
      key = dt.toISOString().slice(0, 7); // by month (YYYY-MM)
    } else {
      key = dt.toISOString().slice(0, 4); // by year
    }
    if (!groups[key]) { groups[key] = []; order.push(key); }
    groups[key].push({ ...d, _dt: dt });
  }
  return { groups, order };
}

function formatGroupLabel(type, key) {
  if (type === '4h') {
    const d = new Date(key + 'T00:00:00+08:00');
    const wd = WEEKDAYS()[d.getDay()];
    const today = new Date(); today.setHours(0,0,0,0);
    const diff = Math.round((today - new Date(d.toDateString())) / 86400000);
    if (diff === 0) return `üìÖ ${t('today')} ¬∑ ${key} ${wd}`;
    if (diff === 1) return `üìÖ ${t('yesterday')} ¬∑ ${key} ${wd}`;
    return `üìÖ ${key} ${wd}`;
  }
  if (type === 'daily') {
    const [y, w] = key.split('-W');
    return t('weekLabel')(y, parseInt(w));
  }
  if (type === 'weekly') {
    const [y, m] = key.split('-');
    return t('monthLabel')(y, parseInt(m));
  }
  if (type === 'monthly') {
    return t('yearLabel')(key);
  }
  return `üìÖ ${key}`;
}

function extractExcerpt(content) {
  if (!content) return '';
  const lines = content.split('\n');
  const highlights = [];
  let inImportant = false;
  for (const line of lines) {
    const trimmed = line.trim();
    // Detect üî•ÈáçË¶Å section
    if (trimmed.includes('üî•')) { inImportant = true; continue; }
    // Stop at next section header
    if (inImportant && (trimmed.startsWith('üì∞') || trimmed.startsWith('üîñ') || trimmed.startsWith('üîç') || trimmed.startsWith('üëÄ') || trimmed.startsWith('üßπ') || trimmed.startsWith('üí§'))) break;
    if (inImportant && trimmed.startsWith('‚Ä¢')) {
      let clean = trimmed.replace(/^‚Ä¢\s*/, '').replace(/\*\*/g, '').replace(/https?:\/\/\S+/g, '').replace(/ÔºàÊù•Ê∫ê[^Ôºâ]*Ôºâ/g, '').trim();
      if (clean.length > 8) highlights.push(clean.length > 80 ? clean.slice(0, 80) + '‚Ä¶' : clean);
      if (highlights.length >= 2) break;
    }
  }
  if (highlights.length) return highlights.join(' ¬∑ ');
  // Fallback: find first bullet with substance
  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#') || trimmed.startsWith('>') || trimmed === '---' || /^[‚òÄÔ∏èüî•üì∞üìÖ]/.test(trimmed) || trimmed.startsWith('*Âü∫‰∫é')) continue;
    let clean = trimmed.replace(/^[‚Ä¢\-\*]\s*/, '').replace(/\*\*/g, '').replace(/https?:\/\/\S+/g, '').trim();
    if (clean.length > 15) return clean.length > 120 ? clean.slice(0, 120) + '‚Ä¶' : clean;
  }
  return '';
}

let loadedDigests = [];

async function renderList(append = false) {
  const list = document.getElementById('list');
  const viewer = document.getElementById('viewer');
  viewer.style.display = 'none';

  if (currentType === 'marks') { renderMarks(); return; }

  if (!append) {
    currentOffset = 0;
    allLoaded = false;
    loadedDigests = [];
    list.innerHTML = `<div class="loading">${t('loading')}</div>`;
  }

  try {
    const resp = await fetch(`${API}/digests?type=${currentType}&limit=${PAGE_SIZE}&offset=${currentOffset}`);
    const digests = await resp.json();
    if (digests.length < PAGE_SIZE) allLoaded = true;
    loadedDigests = loadedDigests.concat(digests);
    currentOffset += digests.length;

    if (!loadedDigests.length) { list.innerHTML = `<div class="empty">${t('noData')}</div>`; return; }

    const { groups, order } = groupDigests(loadedDigests);
    let html = '';
    for (const gk of order) {
      const items = groups[gk];
      const label = formatGroupLabel(currentType, gk);
      html += `<div class="date-group"><div class="date-group-header">${label} <span class="count">${items.length} ${t('articles')}</span></div><div class="date-group-items">`;
      for (const d of items) {
        const dt = d._dt;
        const time = dt.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
        let title, badge;
        if (currentType === '4h') {
          title = `${time} SGT`; badge = `<span class="time-badge">${time}</span>`;
        } else if (currentType === 'daily') {
          const dateStr = dt.toISOString().slice(0, 10);
          const wd = WEEKDAYS()[dt.getDay()];
          title = `${dateStr} ${wd}`; badge = '';
        } else if (currentType === 'weekly') {
          const wk = getWeekKey(dt);
          title = `Á¨¨ ${parseInt(wk.split('-W')[1])} Âë®`; badge = '';
        } else {
          const mon = dt.toISOString().slice(0, 7);
          title = `${parseInt(mon.split('-')[1])} Êúà`; badge = '';
        }
        const excerpt = extractExcerpt(d.content);
        html += `<div class="digest-card" data-id="${d.id}"><div class="card-body"><div class="title">${title}</div>${excerpt ? `<div class="excerpt">${excerpt}</div>` : ''}</div>${badge}</div>`;
      }
      html += `</div></div>`;
    }
    if (!allLoaded) {
      html += `<div id="load-more" style="text-align:center;padding:16px;"><button onclick="loadMore()" style="padding:10px 32px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#aaa;cursor:pointer;font-size:14px;transition:all .2s;">${t('loadMore')}</button></div>`;
    }
    list.innerHTML = html;
    list.querySelectorAll('.digest-card').forEach(card => {
      card.onclick = () => loadDigest(card.dataset.id);
    });
  } catch (e) {
    if (!append) list.innerHTML = `<div class="empty">${t('loadFail')}: ${e.message}</div>`;
  }
}

async function loadMore() {
  const btn = document.querySelector('#load-more button');
  if (btn) { btn.textContent = t('loadingMore'); btn.disabled = true; }
  await renderList(true);
}

async function loadDigest(id) {
  const list = document.getElementById('list');
  const viewer = document.getElementById('viewer');
  list.innerHTML = '';
  try {
    const resp = await fetch(`${API}/digests/${id}`);
    const d = await resp.json();
    let text = d.content;
    // Hide private sections for non-logged-in users
    if (!currentUser) {
      text = text.replace(/üßπ\s*Âª∫ËÆÆÂèñÂÖ≥[\s\S]*?(?=\n(?:üí§|üîç|üëÄ|üì∞|üîñ|üî•|‚Äî|$))/g, '');
      text = text.replace(/üîñ\s*Bookmarks\s*Á≤æÈÄâ[\s\S]*?(?=\n(?:üí§|üîç|üëÄ|üì∞|üßπ|üî•|‚Äî|$))/g, '');
    }
    await loadMarkedUrls();

    text = text.replace(/(https?:\/\/x\.com\/[^\s<)]+)/g, (match) => {
      const clean = match.split('?')[0];
      const isMarked = markedUrls.has(clean);
      let markHtml;
      if (currentUser) {
        markHtml = `<span class="mark-btn ${isMarked ? 'marked' : ''}" onclick="doMark('${clean}', this)">${isMarked ? t('marked') : t('mark')}</span>`;
      } else {
        markHtml = `<span class="mark-btn disabled" onclick="showToast('${t('loginToMark')}')" title="${t('loginToMark')}">${t('mark')}</span>`;
      }
      return `<a href="${match}" target="_blank">${match}</a>${markHtml}`;
    });
    text = text.replace(/(https?:\/\/(?!x\.com)[^\s<)]+)/g, '<a href="$1" target="_blank">$1</a>');

    viewer.innerHTML = `<div class="back-btn" onclick="renderList()">${t('back')}</div>\n${text}`;
    viewer.style.display = 'block';
  } catch (e) {
    viewer.innerHTML = `<div class="back-btn" onclick="renderList()">${t('back')}</div>\n<div class="empty">${t('cantLoad')}</div>`;
    viewer.style.display = 'block';
  }
}

let markViewMode = 'topic'; // 'topic' or 'time'

function getMarkTopic(m) {
  return m.title || 'ÂÖ∂‰ªñ';
}

async function renderMarks() {
  const list = document.getElementById('list');
  if (!currentUser) {
    list.innerHTML = `<div class="login-prompt">
      <div class="icon">üîê</div>
      <div class="msg">${t('loginPromptTitle')}<br>${t('loginPromptDesc')}</div>
      <a class="auth-btn" href="${API}/auth/google?origin=${encodeURIComponent(location.origin)}">${t('signIn')}</a>
    </div>`;
    return;
  }
  list.innerHTML = `<div class="loading">${t('loading')}</div>`;
  try {
    const resp = await fetch(`${API}/marks`, { credentials: 'same-origin' });
    const marks = await resp.json();
    const pending = marks.filter(m => m.status === 'pending');
    const processed = marks.filter(m => m.status === 'processed');

    let html = `<div class="mark-stats">
      <div class="mark-stat"><div class="num">${marks.length}</div><div class="label">${t('totalMarks')}</div></div>
      <div class="mark-stat"><div class="num">${processed.length}</div><div class="label">${t('deepDived')}</div></div>
      <div class="mark-stat"><div class="num" style="color:#f0b040">${pending.length}</div><div class="label">${t('pending')}</div></div>
    </div>`;

    // View toggle
    html += `<div style="display:flex;gap:8px;margin-bottom:16px;">
      <div class="tab ${markViewMode==='topic'?'active':''}" onclick="markViewMode='topic';renderMarks()">${t('byTopic')}</div>
      <div class="tab ${markViewMode==='time'?'active':''}" onclick="markViewMode='time';renderMarks()">${t('byTime')}</div>
    </div>`;

    if (!marks.length) {
      html += `<div class="empty">${t('noMarks')}</div>`;
    } else if (markViewMode === 'topic') {
      // Group by topic
      const topicGroups = {};
      for (const m of marks) {
        const topic = getMarkTopic(m);
        if (!topicGroups[topic]) topicGroups[topic] = [];
        topicGroups[topic].push(m);
      }
      // Sort topics by count desc
      const sortedTopics = Object.entries(topicGroups).sort((a,b) => b[1].length - a[1].length);
      for (const [topic, items] of sortedTopics) {
        html += `<div class="date-group"><div class="date-group-header">${topic} <span class="count">${items.length} ${t('items')}</span></div><div class="date-group-items">`;
        for (const m of items) html += renderMarkCard(m);
        html += `</div></div>`;
      }
    } else {
      // Group by date
      const dateGroups = {}; const dateOrder = [];
      for (const m of marks) {
        const dt = new Date(m.created_at);
        const key = dt.toISOString().slice(0, 10);
        if (!dateGroups[key]) { dateGroups[key] = []; dateOrder.push(key); }
        dateGroups[key].push(m);
      }
      for (const key of dateOrder) {
        const items = dateGroups[key];
        html += `<div class="date-group"><div class="date-group-header">üìÖ ${key} <span class="count">${items.length} ${t('items')}</span></div><div class="date-group-items">`;
        for (const m of items) html += renderMarkCard(m);
        html += `</div></div>`;
      }
    }
    list.innerHTML = html;
  } catch (e) {
    list.innerHTML = `<div class="empty">${t('cannotLoadMarks')}</div>`;
  }
}

function renderMarkCard(m) {
  const authorMatch = m.url.match(/x\.com\/([^/]+)/);
  const author = authorMatch ? authorMatch[1] : '?';
  const isDone = m.status === 'processed';
  const topic = getMarkTopic(m);
  const summary = m.note || '';
  return `<div class="mark-card">
    <div class="mark-meta">
      <span class="mark-author">@${author}</span>
      <span class="mark-status ${isDone ? 'done' : 'pending'}">${isDone ? t('marksDone') : t('marksPending')}</span>
    </div>
    ${summary ? `<div style="font-size:13px;color:#bbb;margin:6px 0;line-height:1.5;">${summary}</div>` : ''}
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
      <a href="${m.url}" target="_blank" style="font-size:12px;color:#555;text-decoration:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;">${m.url.replace('https://x.com/','x.com/')}</a>
      <span style="font-size:11px;color:#555;background:#1a1a1a;padding:1px 6px;border-radius:3px;border:1px solid #282828;">${topic}</span>
    </div>
  </div>`;
}

async function loadMarkedUrls() {
  if (!currentUser) return;
  try {
    const r = await fetch(`${API}/marks`, { credentials: 'same-origin' });
    if (r.ok) {
      const marks = await r.json();
      marks.forEach(m => markedUrls.add(m.url));
    }
  } catch {}
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

async function doMark(url, btn) {
  try {
    const r = await fetch(`${API}/marks`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ url })
    });
    const d = await r.json();
    if (d.ok) {
      markedUrls.add(url);
      btn.textContent = t('marked');
      btn.classList.add('marked');
      btn.onclick = null;
      showToast(d.duplicate ? t('markDup') : t('markSuccess'));
    }
  } catch (e) { showToast(t('markFail') + ': ' + e.message); }
}

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelector('.tab.active').classList.remove('active');
    tab.classList.add('active');
    currentType = tab.dataset.type;
    location.hash = currentType;
    renderList();
  };
});

if (location.hash) {
  const h = location.hash.substring(1);
  if (['4h','daily','weekly','monthly','marks'].includes(h)) {
    currentType = h;
    document.querySelector('.tab.active').classList.remove('active');
    const t = document.querySelector('.tab[data-type="'+h+'"]');
    if (t) t.classList.add('active');
  }
}

applyLang();
checkAuth().then(() => renderList());
</script>
</body>
</html>
