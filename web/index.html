<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Digest Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { overflow-x: hidden; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; word-break: break-word; }
  .container { max-width: 900px; margin: 0 auto; padding: 20px; }
  h1 { font-size: 1.8em; margin-bottom: 8px; }
  @media (max-width: 480px) { h1 { font-size: 1.3em; } }
  .subtitle { color: #888; margin-bottom: 24px; }
  .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
  .tab { padding: 8px 16px; border-radius: 8px; background: #1a1a1a; border: 1px solid #333; cursor: pointer; color: #aaa; font-size: 14px; transition: all 0.2s; }
  .tab:hover { border-color: #555; color: #fff; }
  .tab.active { background: #2a2a2a; border-color: #666; color: #fff; }
  .digest-list { display: flex; flex-direction: column; gap: 16px; }
  .date-group { margin-bottom: 4px; }
  .date-group-header { font-size: 13px; color: #666; font-weight: 600; letter-spacing: 0.5px; padding: 8px 0 6px; border-bottom: 1px solid #1e1e1e; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .date-group-header .count { font-size: 11px; color: #444; font-weight: 400; }
  .date-group-items { display: flex; flex-direction: column; gap: 8px; }
  .digest-card { background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 14px 18px; cursor: pointer; transition: all 0.2s; display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
  .digest-card:hover { border-color: #444; background: #1e1e1e; }
  .digest-card .card-body { flex: 1; min-width: 0; }
  .digest-card .title { font-size: 14px; font-weight: 500; }
  .digest-card .excerpt { font-size: 12px; color: #666; margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }
  .digest-card .time-badge { font-size: 12px; color: #666; background: #141414; padding: 3px 10px; border-radius: 6px; border: 1px solid #222; white-space: nowrap; }
  .digest-viewer { display: none; background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 24px; margin-top: 16px; line-height: 1.7; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; font-size: 14px; max-height: 80vh; overflow-y: auto; overflow-x: hidden; }
  .digest-viewer a { color: #58a6ff; text-decoration: none; }
  .digest-viewer a:hover { text-decoration: underline; }
  .back-btn { display: inline-block; margin-bottom: 16px; padding: 6px 14px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #aaa; cursor: pointer; font-size: 13px; }
  .back-btn:hover { color: #fff; border-color: #666; }
  .empty { color: #555; text-align: center; padding: 40px; font-size: 14px; }
  .loading { color: #555; text-align: center; padding: 20px; }
  .mark-btn { display: inline-block; margin-left: 6px; padding: 1px 8px; font-size: 11px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; color: #f0b040; cursor: pointer; vertical-align: middle; transition: all .15s; text-decoration: none; }
  .mark-btn:hover { background: #3a3a1a; border-color: #f0b040; text-decoration: none; }
  .mark-btn.marked { color: #40c040; border-color: #40c040; cursor: default; }
  .mark-btn.disabled { color: #555; border-color: #333; cursor: pointer; opacity: .6; }
  .mark-btn.disabled:hover { background: #2a2a2a; border-color: #555; }
  .login-prompt { text-align: center; padding: 60px 20px; }
  .login-prompt .icon { font-size: 48px; margin-bottom: 16px; }
  .login-prompt .msg { color: #888; font-size: 15px; line-height: 1.6; margin-bottom: 20px; }
  .login-prompt .auth-btn { display: inline-block; padding: 10px 24px; font-size: 14px; }
  .login-banner { background: #1a1a1a; border: 1px solid #282828; border-radius: 10px; padding: 10px 16px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; font-size: 13px; color: #999; }
  .login-banner a { color: #58a6ff; text-decoration: none; }
  .login-banner a:hover { text-decoration: underline; }
  .login-banner .dismiss { cursor: pointer; color: #555; font-size: 16px; padding: 0 4px; line-height: 1; }
  .login-banner .dismiss:hover { color: #aaa; }
  .auth-bar { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
  .auth-bar img { width: 32px; height: 32px; border-radius: 50%; }
  .auth-bar .user-name { font-size: 13px; color: #aaa; }
  .auth-btn { padding: 6px 14px; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: #ccc; cursor: pointer; font-size: 13px; text-decoration: none; transition: all .2s; }
  .auth-btn:hover { border-color: #666; color: #fff; }
  .container { }
  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 8px; font-size: 13px; z-index: 999; opacity: 0; transition: opacity .3s; pointer-events: none; }
  .toast.show { opacity: 1; }
  .mark-card { background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 16px 20px; transition: all 0.2s; }
  .mark-card:hover { border-color: #444; background: #1e1e1e; }
  .mark-card .mark-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .mark-card .mark-date { font-size: 12px; color: #666; }
  .mark-card .mark-status { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
  .mark-card .mark-status.pending { background: #3a2a00; color: #f0b040; }
  .mark-card .mark-status.done { background: #0a2a0a; color: #40c040; }
  .mark-card .mark-author { font-size: 14px; font-weight: 600; color: #58a6ff; }
  .mark-card .mark-link { margin-top: 6px; }
  .mark-card .mark-link a { font-size: 12px; color: #666; text-decoration: none; word-break: break-all; }
  .mark-card .mark-link a:hover { color: #58a6ff; text-decoration: underline; }
  .mark-stats { display: flex; gap: 16px; margin-bottom: 16px; }
  .mark-stat { background: #1a1a1a; border: 1px solid #282828; border-radius: 8px; padding: 12px 16px; flex: 1; text-align: center; }
  .mark-stat .num { font-size: 24px; font-weight: 700; }
  .mark-stat .label { font-size: 12px; color: #888; margin-top: 2px; }
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;">
    <h1 style="margin:0">â˜€ï¸ AI Digest Dashboard</h1>
    <div class="auth-bar" id="authBar"></div>
  </div>
  <p class="subtitle">Kevin's AI news digest â€” powered by Lisa Â· <a href="https://github.com/kevinho/ai-digest" target="_blank" style="color:#58a6ff;text-decoration:none;">GitHub â­</a></p>
  <div class="tabs">
    <div class="tab active" data-type="4h">4H ç®€æŠ¥</div>
    <div class="tab" data-type="daily">æ—¥æŠ¥</div>
    <div class="tab" data-type="weekly">å‘¨æŠ¥</div>
    <div class="tab" data-type="monthly">æœˆæŠ¥</div>
    <div class="tab" data-type="marks">ğŸ“Œ Mark æ”¶è—</div>
  </div>
  <div id="loginBanner" class="login-banner" style="display:none;">
    <span>ğŸ’¡ ç™»å½• Google è´¦å·å³å¯æ”¶è—æ–‡ç« ã€ç®¡ç†ä¸ªäººä¹¦ç­¾</span>
    <span style="display:flex;align-items:center;gap:10px;">
      <a href="#" id="bannerLogin">ç™»å½•</a>
      <span class="dismiss" onclick="dismissBanner()">âœ•</span>
    </span>
  </div>
  <div id="list" class="digest-list"><div class="loading">Loading...</div></div>
  <div id="viewer" class="digest-viewer"></div>
</div>
<div class="toast" id="toast"></div>

<script>
window.onerror = function(msg, src, line) {
  document.getElementById('list').innerHTML = '<div class="empty">JS Error: ' + msg + ' (line ' + line + ')</div>';
};

// API base â€” auto-detect: if served under /digest/, use /digest/api; otherwise /api
const API = (() => {
  if (location.pathname.startsWith('/digest')) return '/digest/api';
  return '/api';
})();

let currentUser = null;

async function checkAuth() {
  try {
    const r = await fetch(`${API}/auth/me`, { credentials: 'same-origin' });
    if (r.ok) {
      const data = await r.json();
      currentUser = data.user;
    }
  } catch {}
  renderAuthBar();
  updateMarkVisibility();
  if (currentUser && currentType === 'marks') renderMarks();
}

function renderAuthBar() {
  const bar = document.getElementById('authBar');
  if (currentUser) {
    bar.innerHTML = `<img src="${currentUser.avatar}" alt="">`
      + `<span class="user-name">${currentUser.name}</span>`
      + `<a class="auth-btn" href="#" onclick="doLogout(); return false;">é€€å‡º</a>`;
  } else {
    bar.innerHTML = `<a class="auth-btn" href="${API}/auth/google?origin=${encodeURIComponent(location.origin)}">Sign in with Google</a>`;
  }
}

function updateMarkVisibility() {
  // Always show marks tab â€” show login prompt when clicked if not logged in
  // Show/hide login banner
  const banner = document.getElementById('loginBanner');
  if (banner) {
    if (!currentUser && !localStorage.getItem('digest_banner_dismissed')) {
      banner.style.display = '';
      document.getElementById('bannerLogin').href = `${API}/auth/google?origin=${encodeURIComponent(location.origin)}`;
    } else {
      banner.style.display = 'none';
    }
  }
}

function dismissBanner() {
  localStorage.setItem('digest_banner_dismissed', '1');
  document.getElementById('loginBanner').style.display = 'none';
}

async function doLogout() {
  await fetch(`${API}/auth/logout`, { method: 'POST', credentials: 'same-origin' });
  currentUser = null;
  renderAuthBar();
  updateMarkVisibility();
  if (currentType === 'marks') {
    renderList(); // Will show login prompt
  }
}

const WEEKDAYS = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
let currentType = '4h';
let markedUrls = new Set();
const PAGE_SIZE = 10;
let currentOffset = 0;
let allLoaded = false;

function parseCreatedAt(d) {
  const ca = d.created_at;
  // Handle week format: "2026-W07"
  if (/^\d{4}-W\d{2}$/.test(ca)) {
    const [y, w] = ca.split('-W').map(Number);
    // Approximate: week 1 starts Jan 1
    const jan1 = new Date(y, 0, 1);
    return new Date(jan1.getTime() + (w - 1) * 7 * 86400000);
  }
  // Handle month format: "2026-02"
  if (/^\d{4}-\d{2}$/.test(ca)) {
    return new Date(ca + '-01T00:00:00+08:00');
  }
  // Handle year format: "2026"
  if (/^\d{4}$/.test(ca)) {
    return new Date(ca + '-01-01T00:00:00+08:00');
  }
  return new Date(ca.replace(' ', 'T') + (ca.includes('+') ? '' : '+08:00'));
}

function getWeekKey(dt) {
  const d = new Date(dt); d.setHours(0,0,0,0);
  const jan1 = new Date(d.getFullYear(), 0, 1);
  const days = Math.floor((d - jan1) / 86400000);
  const week = Math.ceil((days + jan1.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${String(week).padStart(2, '0')}`;
}

function groupDigests(digests) {
  const groups = {}; const order = [];
  for (const d of digests) {
    const dt = parseCreatedAt(d);
    let key;
    if (currentType === '4h') {
      key = dt.toISOString().slice(0, 10); // by day
    } else if (currentType === 'daily') {
      key = getWeekKey(dt); // by week
    } else if (currentType === 'weekly') {
      key = dt.toISOString().slice(0, 7); // by month (YYYY-MM)
    } else {
      key = dt.toISOString().slice(0, 4); // by year
    }
    if (!groups[key]) { groups[key] = []; order.push(key); }
    groups[key].push({ ...d, _dt: dt });
  }
  return { groups, order };
}

function formatGroupLabel(type, key) {
  if (type === '4h') {
    const d = new Date(key + 'T00:00:00+08:00');
    const wd = WEEKDAYS[d.getDay()];
    const today = new Date(); today.setHours(0,0,0,0);
    const diff = Math.round((today - new Date(d.toDateString())) / 86400000);
    if (diff === 0) return `ğŸ“… ä»Šå¤© Â· ${key} ${wd}`;
    if (diff === 1) return `ğŸ“… æ˜¨å¤© Â· ${key} ${wd}`;
    return `ğŸ“… ${key} ${wd}`;
  }
  if (type === 'daily') {
    // key = "2026-W07"
    const [y, w] = key.split('-W');
    return `ğŸ“… ${y} ç¬¬ ${parseInt(w)} å‘¨`;
  }
  if (type === 'weekly') {
    // key = "2026-02"
    const [y, m] = key.split('-');
    return `ğŸ“… ${y} å¹´ ${parseInt(m)} æœˆ`;
  }
  if (type === 'monthly') {
    return `ğŸ“… ${key} å¹´`;
  }
  return `ğŸ“… ${key}`;
}

function extractExcerpt(content) {
  if (!content) return '';
  const lines = content.split('\n');
  const highlights = [];
  let inImportant = false;
  for (const line of lines) {
    const trimmed = line.trim();
    // Detect ğŸ”¥é‡è¦ section
    if (trimmed.includes('ğŸ”¥')) { inImportant = true; continue; }
    // Stop at next section header
    if (inImportant && (trimmed.startsWith('ğŸ“°') || trimmed.startsWith('ğŸ”–') || trimmed.startsWith('ğŸ”') || trimmed.startsWith('ğŸ‘€') || trimmed.startsWith('ğŸ§¹') || trimmed.startsWith('ğŸ’¤'))) break;
    if (inImportant && trimmed.startsWith('â€¢')) {
      let clean = trimmed.replace(/^â€¢\s*/, '').replace(/\*\*/g, '').replace(/https?:\/\/\S+/g, '').replace(/ï¼ˆæ¥æº[^ï¼‰]*ï¼‰/g, '').trim();
      if (clean.length > 8) highlights.push(clean.length > 80 ? clean.slice(0, 80) + 'â€¦' : clean);
      if (highlights.length >= 2) break;
    }
  }
  if (highlights.length) return highlights.join(' Â· ');
  // Fallback: find first bullet with substance
  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#') || trimmed.startsWith('>') || trimmed === '---' || /^[â˜€ï¸ğŸ”¥ğŸ“°ğŸ“…]/.test(trimmed) || trimmed.startsWith('*åŸºäº')) continue;
    let clean = trimmed.replace(/^[â€¢\-\*]\s*/, '').replace(/\*\*/g, '').replace(/https?:\/\/\S+/g, '').trim();
    if (clean.length > 15) return clean.length > 120 ? clean.slice(0, 120) + 'â€¦' : clean;
  }
  return '';
}

let loadedDigests = [];

async function renderList(append = false) {
  const list = document.getElementById('list');
  const viewer = document.getElementById('viewer');
  viewer.style.display = 'none';

  if (currentType === 'marks') { renderMarks(); return; }

  if (!append) {
    currentOffset = 0;
    allLoaded = false;
    loadedDigests = [];
    list.innerHTML = '<div class="loading">Loading...</div>';
  }

  try {
    const resp = await fetch(`${API}/digests?type=${currentType}&limit=${PAGE_SIZE}&offset=${currentOffset}`);
    const digests = await resp.json();
    if (digests.length < PAGE_SIZE) allLoaded = true;
    loadedDigests = loadedDigests.concat(digests);
    currentOffset += digests.length;

    if (!loadedDigests.length) { list.innerHTML = '<div class="empty">æš‚æ— æ•°æ®</div>'; return; }

    const { groups, order } = groupDigests(loadedDigests);
    let html = '';
    for (const gk of order) {
      const items = groups[gk];
      const label = formatGroupLabel(currentType, gk);
      html += `<div class="date-group"><div class="date-group-header">${label} <span class="count">${items.length} ç¯‡</span></div><div class="date-group-items">`;
      for (const d of items) {
        const dt = d._dt;
        const time = dt.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
        let title, badge;
        if (currentType === '4h') {
          title = `${time} SGT`; badge = `<span class="time-badge">${time}</span>`;
        } else if (currentType === 'daily') {
          const dateStr = dt.toISOString().slice(0, 10);
          const wd = WEEKDAYS[dt.getDay()];
          title = `${dateStr} ${wd}`; badge = '';
        } else if (currentType === 'weekly') {
          const wk = getWeekKey(dt);
          title = `ç¬¬ ${parseInt(wk.split('-W')[1])} å‘¨`; badge = '';
        } else {
          const mon = dt.toISOString().slice(0, 7);
          title = `${parseInt(mon.split('-')[1])} æœˆ`; badge = '';
        }
        const excerpt = extractExcerpt(d.content);
        html += `<div class="digest-card" data-id="${d.id}"><div class="card-body"><div class="title">${title}</div>${excerpt ? `<div class="excerpt">${excerpt}</div>` : ''}</div>${badge}</div>`;
      }
      html += `</div></div>`;
    }
    if (!allLoaded) {
      html += `<div id="load-more" style="text-align:center;padding:16px;"><button onclick="loadMore()" style="padding:10px 32px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#aaa;cursor:pointer;font-size:14px;transition:all .2s;">åŠ è½½æ›´å¤š</button></div>`;
    }
    list.innerHTML = html;
    list.querySelectorAll('.digest-card').forEach(card => {
      card.onclick = () => loadDigest(card.dataset.id);
    });
  } catch (e) {
    if (!append) list.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${e.message}</div>`;
  }
}

async function loadMore() {
  const btn = document.querySelector('#load-more button');
  if (btn) { btn.textContent = 'åŠ è½½ä¸­...'; btn.disabled = true; }
  await renderList(true);
}

async function loadDigest(id) {
  const list = document.getElementById('list');
  const viewer = document.getElementById('viewer');
  list.innerHTML = '';
  try {
    const resp = await fetch(`${API}/digests/${id}`);
    const d = await resp.json();
    let text = d.content;
    // Hide private sections for non-logged-in users
    if (!currentUser) {
      text = text.replace(/ğŸ§¹\s*å»ºè®®å–å…³[\s\S]*?(?=\n(?:ğŸ’¤|ğŸ”|ğŸ‘€|ğŸ“°|ğŸ”–|ğŸ”¥|â€”|$))/g, '');
      text = text.replace(/ğŸ”–\s*Bookmarks\s*ç²¾é€‰[\s\S]*?(?=\n(?:ğŸ’¤|ğŸ”|ğŸ‘€|ğŸ“°|ğŸ§¹|ğŸ”¥|â€”|$))/g, '');
    }
    await loadMarkedUrls();

    text = text.replace(/(https?:\/\/x\.com\/[^\s<)]+)/g, (match) => {
      const clean = match.split('?')[0];
      const isMarked = markedUrls.has(clean);
      let markHtml;
      if (currentUser) {
        markHtml = `<span class="mark-btn ${isMarked ? 'marked' : ''}" onclick="doMark('${clean}', this)">${isMarked ? 'âœ… å·² Mark' : 'ğŸ“Œ Mark'}</span>`;
      } else {
        markHtml = `<span class="mark-btn disabled" onclick="showToast('ğŸ” ç™»å½•åå¯æ”¶è—')" title="ç™»å½•åå¯æ”¶è—">ğŸ“Œ Mark</span>`;
      }
      return `<a href="${match}" target="_blank">${match}</a>${markHtml}`;
    });
    text = text.replace(/(https?:\/\/(?!x\.com)[^\s<)]+)/g, '<a href="$1" target="_blank">$1</a>');

    viewer.innerHTML = `<div class="back-btn" onclick="renderList()">â† è¿”å›åˆ—è¡¨</div>\n${text}`;
    viewer.style.display = 'block';
  } catch (e) {
    viewer.innerHTML = `<div class="back-btn" onclick="renderList()">â† è¿”å›åˆ—è¡¨</div>\n<div class="empty">æ— æ³•åŠ è½½</div>`;
    viewer.style.display = 'block';
  }
}

let markViewMode = 'topic'; // 'topic' or 'time'

function getMarkTopic(m) {
  return m.title || 'å…¶ä»–';
}

async function renderMarks() {
  const list = document.getElementById('list');
  if (!currentUser) {
    list.innerHTML = `<div class="login-prompt">
      <div class="icon">ğŸ”</div>
      <div class="msg">ç™»å½•åå¯ä½¿ç”¨æ”¶è—åŠŸèƒ½<br>æ”¶è—æ„Ÿå…´è¶£çš„å†…å®¹ï¼Œéšæ—¶å›é¡¾</div>
      <a class="auth-btn" href="${API}/auth/google?origin=${encodeURIComponent(location.origin)}">Sign in with Google</a>
    </div>`;
    return;
  }
  list.innerHTML = '<div class="loading">Loading marks...</div>';
  try {
    const resp = await fetch(`${API}/marks`, { credentials: 'same-origin' });
    const marks = await resp.json();
    const pending = marks.filter(m => m.status === 'pending');
    const processed = marks.filter(m => m.status === 'processed');

    let html = `<div class="mark-stats">
      <div class="mark-stat"><div class="num">${marks.length}</div><div class="label">æ€» Mark</div></div>
      <div class="mark-stat"><div class="num">${processed.length}</div><div class="label">å·² Deep Dive</div></div>
      <div class="mark-stat"><div class="num" style="color:#f0b040">${pending.length}</div><div class="label">å¾…å¤„ç†</div></div>
    </div>`;

    // View toggle
    html += `<div style="display:flex;gap:8px;margin-bottom:16px;">
      <div class="tab ${markViewMode==='topic'?'active':''}" onclick="markViewMode='topic';renderMarks()">ğŸ·ï¸ æŒ‰è¯é¢˜</div>
      <div class="tab ${markViewMode==='time'?'active':''}" onclick="markViewMode='time';renderMarks()">ğŸ• æŒ‰æ—¶é—´</div>
    </div>`;

    if (!marks.length) {
      html += '<div class="empty">æš‚æ—  Mark è®°å½•</div>';
    } else if (markViewMode === 'topic') {
      // Group by topic
      const topicGroups = {};
      for (const m of marks) {
        const topic = getMarkTopic(m);
        if (!topicGroups[topic]) topicGroups[topic] = [];
        topicGroups[topic].push(m);
      }
      // Sort topics by count desc
      const sortedTopics = Object.entries(topicGroups).sort((a,b) => b[1].length - a[1].length);
      for (const [topic, items] of sortedTopics) {
        html += `<div class="date-group"><div class="date-group-header">${topic} <span class="count">${items.length} æ¡</span></div><div class="date-group-items">`;
        for (const m of items) html += renderMarkCard(m);
        html += `</div></div>`;
      }
    } else {
      // Group by date
      const dateGroups = {}; const dateOrder = [];
      for (const m of marks) {
        const dt = new Date(m.created_at);
        const key = dt.toISOString().slice(0, 10);
        if (!dateGroups[key]) { dateGroups[key] = []; dateOrder.push(key); }
        dateGroups[key].push(m);
      }
      for (const key of dateOrder) {
        const items = dateGroups[key];
        html += `<div class="date-group"><div class="date-group-header">ğŸ“… ${key} <span class="count">${items.length} æ¡</span></div><div class="date-group-items">`;
        for (const m of items) html += renderMarkCard(m);
        html += `</div></div>`;
      }
    }
    list.innerHTML = html;
  } catch (e) {
    list.innerHTML = '<div class="empty">æ— æ³•åŠ è½½ Marks æ•°æ®</div>';
  }
}

function renderMarkCard(m) {
  const authorMatch = m.url.match(/x\.com\/([^/]+)/);
  const author = authorMatch ? authorMatch[1] : '?';
  const isDone = m.status === 'processed';
  const topic = getMarkTopic(m);
  const summary = m.note || '';
  return `<div class="mark-card">
    <div class="mark-meta">
      <span class="mark-author">@${author}</span>
      <span class="mark-status ${isDone ? 'done' : 'pending'}">${isDone ? 'âœ… å·²è§£è¯»' : 'â³ å¾…å¤„ç†'}</span>
    </div>
    ${summary ? `<div style="font-size:13px;color:#bbb;margin:6px 0;line-height:1.5;">${summary}</div>` : ''}
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
      <a href="${m.url}" target="_blank" style="font-size:12px;color:#555;text-decoration:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;">${m.url.replace('https://x.com/','x.com/')}</a>
      <span style="font-size:11px;color:#555;background:#1a1a1a;padding:1px 6px;border-radius:3px;border:1px solid #282828;">${topic}</span>
    </div>
  </div>`;
}

async function loadMarkedUrls() {
  if (!currentUser) return;
  try {
    const r = await fetch(`${API}/marks`, { credentials: 'same-origin' });
    if (r.ok) {
      const marks = await r.json();
      marks.forEach(m => markedUrls.add(m.url));
    }
  } catch {}
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

async function doMark(url, btn) {
  try {
    const r = await fetch(`${API}/marks`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ url })
    });
    const d = await r.json();
    if (d.ok) {
      markedUrls.add(url);
      btn.textContent = 'âœ… å·² Mark';
      btn.classList.add('marked');
      btn.onclick = null;
      showToast(d.duplicate ? 'å·²ç» Mark è¿‡äº†' : 'ğŸ“Œ Mark æˆåŠŸï¼');
    }
  } catch (e) { showToast('âŒ Mark å¤±è´¥: ' + e.message); }
}

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelector('.tab.active').classList.remove('active');
    tab.classList.add('active');
    currentType = tab.dataset.type;
    location.hash = currentType;
    renderList();
  };
});

if (location.hash) {
  const h = location.hash.substring(1);
  if (['4h','daily','weekly','monthly','marks'].includes(h)) {
    currentType = h;
    document.querySelector('.tab.active').classList.remove('active');
    const t = document.querySelector('.tab[data-type="'+h+'"]');
    if (t) t.classList.add('active');
  }
}

checkAuth().then(() => renderList());
</script>
</body>
</html>
