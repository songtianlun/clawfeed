<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Digest Dashboard</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚òÄÔ∏è</text></svg>">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { overflow-x: hidden; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; word-break: break-word; }
  .container { max-width: 900px; margin: 0 auto; padding: 20px; }
  h1 { font-size: 1.8em; margin-bottom: 8px; }
  @media (max-width: 480px) { h1 { font-size: 1.3em; } }
  .subtitle { color: #888; margin-bottom: 24px; }
  /* Changelog modal */
  .changelog-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; overflow-y:auto; display:none; }
  .changelog-overlay.open { display:flex; justify-content:center; }
  .changelog-inner { max-width:750px; width:100%; padding:40px 24px 60px; color:#e0e0e0; position:relative; }
  .changelog-close { position:fixed; top:16px; right:24px; font-size:28px; color:#888; cursor:pointer; z-index:10000; background:none; border:none; }
  .changelog-close:hover { color:#fff; }
  .changelog-inner h1 { font-size:2em; margin-bottom:24px; color:#fff; }
  .changelog-inner h2 { font-size:1.4em; margin:32px 0 8px; color:#6cf; border-bottom:1px solid #333; padding-bottom:8px; }
  .changelog-inner h3 { font-size:1.1em; margin:16px 0 8px; color:#ccc; }
  .changelog-inner ul { margin:0 0 8px 20px; }
  .changelog-inner li { margin:4px 0; line-height:1.6; color:#bbb; }
  .changelog-inner code { background:#1a1a2e; padding:2px 6px; border-radius:3px; font-size:0.9em; color:#6cf; }
  .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
  .tab { padding: 8px 16px; border-radius: 8px; background: #1a1a1a; border: 1px solid #333; cursor: pointer; color: #aaa; font-size: 14px; transition: all 0.2s; }
  .tab:hover { border-color: #555; color: #fff; }
  .tab.active { background: #2a2a2a; border-color: #666; color: #fff; }
  .digest-list { display: flex; flex-direction: column; gap: 16px; }
  .date-group { margin-bottom: 4px; }
  .date-group-header { font-size: 13px; color: #666; font-weight: 600; letter-spacing: 0.5px; padding: 8px 0 6px; border-bottom: 1px solid #1e1e1e; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .date-group-header .count { font-size: 11px; color: #444; font-weight: 400; }
  .date-group-items { display: flex; flex-direction: column; gap: 8px; }
  .digest-card { background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 14px 18px; cursor: pointer; transition: all 0.2s; display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
  .digest-card:hover { border-color: #444; background: #1e1e1e; }
  .digest-card .card-body { flex: 1; min-width: 0; }
  .digest-card .title { font-size: 14px; font-weight: 500; }
  .digest-card .excerpt { font-size: 12px; color: #666; margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }
  .digest-card .time-badge { font-size: 12px; color: #666; background: #141414; padding: 3px 10px; border-radius: 6px; border: 1px solid #222; white-space: nowrap; }
  .digest-viewer { display: none; background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 24px; margin-top: 16px; line-height: 1.7; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; font-size: 14px; max-height: 80vh; overflow-y: auto; overflow-x: hidden; }
  .digest-viewer a { color: #58a6ff; text-decoration: none; }
  .digest-viewer a:hover { text-decoration: underline; }
  .back-btn { display: inline-block; margin-bottom: 16px; padding: 6px 14px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #aaa; cursor: pointer; font-size: 13px; }
  .back-btn:hover { color: #fff; border-color: #666; }
  .empty { color: #555; text-align: center; padding: 40px; font-size: 14px; }
  .loading { color: #555; text-align: center; padding: 20px; }
  .mark-btn { display: inline-block; margin-left: 6px; padding: 1px 8px; font-size: 11px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; color: #f0b040; cursor: pointer; vertical-align: middle; transition: all .15s; text-decoration: none; }
  .mark-btn:hover { background: #3a3a1a; border-color: #f0b040; text-decoration: none; }
  .mark-btn.marked { color: #40c040; border-color: #40c040; cursor: default; }
  .mark-btn.disabled { color: #555; border-color: #333; cursor: pointer; opacity: .6; }
  .mark-btn.disabled:hover { background: #2a2a2a; border-color: #555; }
  .login-prompt { text-align: center; padding: 60px 20px; }
  .login-prompt .icon { font-size: 48px; margin-bottom: 16px; }
  .login-prompt .msg { color: #888; font-size: 15px; line-height: 1.6; margin-bottom: 20px; }
  .login-prompt .auth-btn { display: inline-block; padding: 10px 24px; font-size: 14px; }
  .login-banner { background: #1a1a1a; border: 1px solid #282828; border-radius: 10px; padding: 10px 16px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; font-size: 13px; color: #999; }
  .login-banner a { color: #58a6ff; text-decoration: none; }
  .login-banner a:hover { text-decoration: underline; }
  .login-banner .dismiss { cursor: pointer; color: #555; font-size: 16px; padding: 0 4px; line-height: 1; }
  .login-banner .dismiss:hover { color: #aaa; }
  .auth-bar { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .auth-tools { display: flex; align-items: center; gap: 6px; padding-left: 8px; border-left: 1px solid #333; margin-left: 2px; }
  .auth-bar img { width: 32px; height: 32px; border-radius: 50%; }
  .auth-bar .user-name { font-size: 13px; color: #aaa; }
  .user-menu { position: relative; display: flex; align-items: center; gap: 8px; cursor: pointer; }
  .user-dropdown { display: none; position: absolute; top: 100%; right: 0; margin-top: 6px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 6px 0; min-width: 120px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,.4); }
  .user-dropdown.show { display: block; }
  .user-dropdown a { display: block; padding: 8px 16px; color: #aaa; text-decoration: none; font-size: 13px; transition: all .15s; }
  .user-dropdown a:hover { background: #2a2a2a; color: #fff; }
  .auth-btn { padding: 6px 14px; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: #ccc; cursor: pointer; font-size: 13px; text-decoration: none; transition: all .2s; }
  .auth-btn:hover { border-color: #666; color: #fff; }
  .container { }
  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 8px; font-size: 13px; z-index: 999; opacity: 0; transition: opacity .3s; pointer-events: none; }
  .toast.show { opacity: 1; }
  .mark-card { background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 16px 20px; transition: all 0.2s; }
  .mark-card:hover { border-color: #444; background: #1e1e1e; }
  .mark-card .mark-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .mark-card .mark-date { font-size: 12px; color: #666; }
  .mark-card .mark-status { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
  .mark-card .mark-status.pending { background: #3a2a00; color: #f0b040; }
  .mark-card .mark-status.done { background: #0a2a0a; color: #40c040; }
  .mark-card .mark-author { font-size: 14px; font-weight: 600; color: #58a6ff; }
  .mark-card .mark-link { margin-top: 6px; }
  .mark-card .mark-link a { font-size: 12px; color: #666; text-decoration: none; word-break: break-all; }
  .mark-card .mark-link a:hover { color: #58a6ff; text-decoration: underline; }
  .mark-stats { display: flex; gap: 16px; margin-bottom: 16px; }
  .mark-stat { background: #1a1a1a; border: 1px solid #282828; border-radius: 8px; padding: 12px 16px; flex: 1; text-align: center; }
  .mark-stat .num { font-size: 24px; font-weight: 700; }
  .mark-stat .label { font-size: 12px; color: #888; margin-top: 2px; }
  .source-card { background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 16px 20px; transition: all 0.2s; }
  .source-card:hover { border-color: #444; background: #1e1e1e; }
  .source-card .source-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
  .source-card .source-name { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .source-card .source-meta { font-size: 12px; color: #666; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap; }
  .source-actions { display: flex; gap: 6px; align-items: center; }
  .source-actions button { padding: 4px 10px; font-size: 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #aaa; cursor: pointer; transition: all .15s; }
  .source-actions button:hover { border-color: #666; color: #fff; }
  .source-actions button.danger:hover { border-color: #f04040; color: #f04040; }
  .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; cursor: pointer; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; inset: 0; background: #333; border-radius: 20px; transition: .3s; }
  .toggle-slider:before { content: ''; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background: #888; border-radius: 50%; transition: .3s; }
  .toggle-switch input:checked + .toggle-slider { background: #2a5a2a; }
  .toggle-switch input:checked + .toggle-slider:before { transform: translateX(16px); background: #40c040; }
  .source-form { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
  .source-form .form-row { margin-bottom: 12px; }
  .source-form label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
  .source-form input, .source-form select, .source-form textarea { width: 100%; padding: 8px 12px; background: #0f0f0f; border: 1px solid #333; border-radius: 6px; color: #e0e0e0; font-size: 13px; font-family: inherit; }
  .source-form textarea { min-height: 60px; resize: vertical; font-family: monospace; }
  .source-form .form-actions { display: flex; gap: 8px; margin-top: 16px; }
  .source-form .form-actions button { padding: 8px 20px; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: #ccc; cursor: pointer; font-size: 13px; transition: all .2s; }
  .source-form .form-actions button.primary { background: #1a3a1a; border-color: #40c040; color: #40c040; }
  .source-form .form-actions button:hover { border-color: #666; color: #fff; }
  .pack-card { background: #1a1a1a; border: 1px solid #282828; border-radius: 12px; padding: 16px 20px; transition: all 0.2s; }
  .pack-card:hover { border-color: #444; background: #1e1e1e; }
  .pack-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
  .pack-name { font-size: 16px; font-weight: 600; }
  .pack-desc { font-size: 13px; color: #888; margin-top: 4px; }
  .pack-meta { display: flex; gap: 12px; align-items: center; margin-top: 10px; font-size: 12px; color: #666; flex-wrap: wrap; }
  .pack-meta img { width: 20px; height: 20px; border-radius: 50%; }
  .pack-sources-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
  .pack-source-tag { font-size: 11px; padding: 3px 8px; background: #141414; border: 1px solid #282828; border-radius: 6px; color: #aaa; }
  .pack-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
  .pack-actions button { padding: 6px 16px; font-size: 12px; border-radius: 6px; cursor: pointer; transition: all .2s; }
  .pack-install-btn { background: #1a3a1a; border: 1px solid #40c040; color: #40c040; }
  .pack-install-btn:hover { background: #2a4a2a; }
  .pack-install-btn.done { background: #1a2a1a; border-color: #336633; color: #666; cursor: default; }
  .pack-delete-btn { background: #2a2a2a; border: 1px solid #444; color: #aaa; }
  .pack-delete-btn:hover { border-color: #f04040; color: #f04040; }
  .pack-detail-page { max-width: 700px; margin: 0 auto; }
  .pack-detail-sources { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
  .pack-detail-source { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #141414; border: 1px solid #222; border-radius: 8px; }
  .pack-detail-source .icon { font-size: 18px; }
  .pack-detail-source .info { flex: 1; }
  .pack-detail-source .info .name { font-size: 14px; font-weight: 500; }
  .pack-detail-source .info .type { font-size: 11px; color: #666; }
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;">
    <h1 style="margin:0;cursor:pointer" onclick="goHome()">‚òÄÔ∏è AI Digest Dashboard</h1>
    <div class="auth-bar" id="authBar"></div>
  </div>
  <p class="subtitle"><span id="subtitleText">Kevin's AI news digest ‚Äî powered by Lisa</span></p>
  <div class="tabs">
    <div class="tab active" data-type="4h">4H ÁÆÄÊä•</div>
    <div class="tab" data-type="daily">Êó•Êä•</div>
    <div class="tab" data-type="weekly">Âë®Êä•</div>
    <div class="tab" data-type="monthly">ÊúàÊä•</div>
    <div class="tab" data-type="marks">üìå Mark Êî∂Ëóè</div>
  </div>
  <div id="loginBanner" class="login-banner" style="display:none;">
    <span>üí° ÁôªÂΩï Google Ë¥¶Âè∑Âç≥ÂèØÊî∂ËóèÊñáÁ´†„ÄÅÁÆ°ÁêÜ‰∏™‰∫∫‰π¶Á≠æ</span>
    <span style="display:flex;align-items:center;gap:10px;">
      <a href="#" id="bannerLogin">ÁôªÂΩï</a>
      <span class="dismiss" onclick="dismissBanner()">‚úï</span>
    </span>
  </div>
  <div id="list" class="digest-list"><div class="loading">‚è≥</div></div>
  <div id="viewer" class="digest-viewer"></div>
</div>
<div class="toast" id="toast"></div>
<div class="changelog-overlay" id="changelogOverlay">
  <button class="changelog-close" onclick="hideChangelog()">‚úï</button>
  <div class="changelog-inner" id="changelogContent"></div>
</div>

<script>
window.onerror = function(msg, src, line) {
  document.getElementById('list').innerHTML = '<div class="empty">JS Error: ' + msg + ' (line ' + line + ')</div>';
};

// ‚îÄ‚îÄ i18n ‚îÄ‚îÄ
const I18N = {
  zh: {
    title: '‚òÄÔ∏è AI Digest Dashboard',
    subtitle: 'AI Êñ∞ÈóªÁÆÄÊä• ‚Äî powered by Lisa',
    tab4h: '4H ÁÆÄÊä•', tabDaily: 'Êó•Êä•', tabWeekly: 'Âë®Êä•', tabMonthly: 'ÊúàÊä•', tabMarks: 'üìå Mark Êî∂Ëóè',
    loginBanner: 'üí° ÁôªÂΩï Google Ë¥¶Âè∑Âç≥ÂèØÊî∂ËóèÊñáÁ´†„ÄÅÁÆ°ÁêÜ‰∏™‰∫∫‰π¶Á≠æ',
    loginBtn: 'ÁôªÂΩï', logout: 'ÈÄÄÂá∫', signIn: 'Sign in with Google',
    loading: 'Âä†ËΩΩ‰∏≠...', noData: 'ÊöÇÊó†Êï∞ÊçÆ', loadMore: 'Âä†ËΩΩÊõ¥Â§ö', loadingMore: 'Âä†ËΩΩ‰∏≠...',
    loadFail: 'Âä†ËΩΩÂ§±Ë¥•', back: '‚Üê ËøîÂõûÂàóË°®', cantLoad: 'Êó†Ê≥ïÂä†ËΩΩ',
    today: '‰ªäÂ§©', yesterday: 'Êò®Â§©', articles: 'ÁØá',
    weekLabel: (y, w) => `üìÖ ${y} Á¨¨ ${w} Âë®`,
    monthLabel: (y, m) => `üìÖ ${y} Âπ¥ ${m} Êúà`,
    yearLabel: (y) => `üìÖ ${y} Âπ¥`,
    totalMarks: 'ÊÄª Mark', deepDived: 'Â∑≤ Deep Dive', pending: 'ÂæÖÂ§ÑÁêÜ',
    byTopic: 'üè∑Ô∏è ÊåâËØùÈ¢ò', byTime: 'üïê ÊåâÊó∂Èó¥',
    noMarks: 'ÊöÇÊó† Mark ËÆ∞ÂΩï', marksDone: '‚úÖ Â∑≤Ëß£ËØª', marksPending: '‚è≥ ÂæÖÂ§ÑÁêÜ',
    loginToMark: 'üîê ÁôªÂΩïÂêéÂèØÊî∂Ëóè',
    loginPromptTitle: 'ÁôªÂΩïÂêéÂèØ‰ΩøÁî®Êî∂ËóèÂäüËÉΩ',
    loginPromptDesc: 'Êî∂ËóèÊÑüÂÖ¥Ë∂£ÁöÑÂÜÖÂÆπÔºåÈöèÊó∂ÂõûÈ°æ',
    markSuccess: 'üìå Mark ÊàêÂäüÔºÅ', markDup: 'Â∑≤Áªè Mark Ëøá‰∫Ü', markFail: '‚ùå Mark Â§±Ë¥•',
    marked: '‚úÖ Â∑≤ Mark', mark: 'üìå Mark',
    items: 'Êù°', cannotLoadMarks: 'Êó†Ê≥ïÂä†ËΩΩ Marks Êï∞ÊçÆ',
    weekdays: ['Âë®Êó•','Âë®‰∏Ä','Âë®‰∫å','Âë®‰∏â','Âë®Âõõ','Âë®‰∫î','Âë®ÂÖ≠'],
    tabSources: 'üì° Êï∞ÊçÆÊ∫ê',
    sourcesTotal: 'ÊÄªÊï∞', sourcesActive: 'Ê¥ªË∑É', sourcesTypes: 'Á±ªÂûã',
    addSource: '‚ûï Ê∑ªÂä†Ê∫ê', editSource: 'ÁºñËæë', deleteSource: 'Âà†Èô§',
    sourceName: 'ÂêçÁß∞', sourceType: 'Á±ªÂûã', sourceConfig: 'ÈÖçÁΩÆ (JSON)', sourcePublic: 'ÂÖ¨ÂºÄ',
    save: '‰øùÂ≠ò', cancel: 'ÂèñÊ∂à',
    noSources: 'ÊöÇÊó†Êï∞ÊçÆÊ∫ê', confirmDelete: 'Á°ÆÂÆöÂà†Èô§Ê≠§Êï∞ÊçÆÊ∫êÔºü',
    lastFetched: '‰∏äÊ¨°ÊäìÂèñ', fetchCount: 'ÊäìÂèñÊ¨°Êï∞', never: '‰ªéÊú™',
    sourceCreated: '‚úÖ Êï∞ÊçÆÊ∫êÂ∑≤ÂàõÂª∫', sourceUpdated: '‚úÖ Â∑≤Êõ¥Êñ∞', sourceDeleted: '‚úÖ Â∑≤Âà†Èô§',
    pasteUrl: 'üîó Á≤òË¥¥ URL Ê∑ªÂä†‰ø°ÊÅØÊ∫ê', detect: 'ËØÜÂà´', detecting: 'ËØÜÂà´‰∏≠...', detected: 'ËØÜÂà´ÊàêÂäü', previewRecent: 'ÊúÄËøëÂÜÖÂÆπ',
    cannotDetect: 'Êó†Ê≥ïËá™Âä®ËØÜÂà´Ôºå', manualAdd: 'ÊâãÂä®Ê∑ªÂä†', confirmAdd: 'Á°ÆËÆ§Ê∑ªÂä†',
    urlPlaceholder: 'https://...', publicSource: 'ÂÖ¨ÂºÄ',
    changelog: 'Êõ¥Êñ∞Êó•Âøó',
    sharePack: 'üì¶ ÂàÜ‰∫´‰∏∫ Pack', browsePacks: 'üîç ÊµèËßà Packs',
    packName: 'Pack ÂêçÁß∞', packDesc: 'ÊèèËø∞ÔºàÂèØÈÄâÔºâ',
    createPack: 'ÂàõÂª∫ Pack', packCreated: '‚úÖ Pack Â∑≤ÂàõÂª∫ÔºÅ',
    packInstalled: '‚úÖ Â∑≤ÂÆâË£ÖÔºÅ', packAlreadyHave: '‰Ω†Â∑≤ÊúâÊâÄÊúâËøô‰∫õÊ∫ê',
    installPack: 'ÂÆâË£Ö', installed: 'Â∑≤ÂÆâË£Ö ‚úÖ', loginToInstall: 'ÁôªÂΩïÂêéÂÆâË£Ö',
    packSources: 'ÂåÖÂê´ÁöÑÊ∫ê', packInstalls: 'Ê¨°ÂÆâË£Ö', packBy: 'ÂàõÂª∫ËÄÖ',
    deletePack: 'Âà†Èô§', packDeleted: '‚úÖ Pack Â∑≤Âà†Èô§',
    shareLink: 'ÂàÜ‰∫´ÈìæÊé•', copied: 'Â∑≤Â§çÂà∂ÔºÅ', noPacks: 'ÊöÇÊó† Pack',
    myPacks: 'ÊàëÁöÑ Packs', backToPacks: '‚Üê ËøîÂõû Packs',
    newAdded: 'Êñ∞Â¢û', skipped: 'Ë∑≥ËøáÔºàÂ∑≤ÊúâÔºâ',
  },
  en: {
    title: '‚òÄÔ∏è AI Digest Dashboard',
    subtitle: 'AI news digest ‚Äî powered by Lisa',
    tab4h: '4H Briefs', tabDaily: 'Daily', tabWeekly: 'Weekly', tabMonthly: 'Monthly', tabMarks: 'üìå Marks',
    loginBanner: 'üí° Sign in with Google to bookmark articles and manage your reading list',
    loginBtn: 'Login', logout: 'Logout', signIn: 'Sign in with Google',
    loading: 'Loading...', noData: 'No data', loadMore: 'Load More', loadingMore: 'Loading...',
    loadFail: 'Failed to load', back: '‚Üê Back', cantLoad: 'Cannot load',
    today: 'Today', yesterday: 'Yesterday', articles: 'articles',
    weekLabel: (y, w) => `üìÖ ${y} Week ${w}`,
    monthLabel: (y, m) => `üìÖ ${['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m]} ${y}`,
    yearLabel: (y) => `üìÖ ${y}`,
    totalMarks: 'Total', deepDived: 'Deep Dived', pending: 'Pending',
    byTopic: 'üè∑Ô∏è By Topic', byTime: 'üïê By Time',
    noMarks: 'No marks yet', marksDone: '‚úÖ Done', marksPending: '‚è≥ Pending',
    loginToMark: 'üîê Sign in to bookmark',
    loginPromptTitle: 'Sign in to use bookmarks',
    loginPromptDesc: 'Save interesting content and revisit anytime',
    markSuccess: 'üìå Marked!', markDup: 'Already marked', markFail: '‚ùå Mark failed',
    marked: '‚úÖ Marked', mark: 'üìå Mark',
    items: 'items', cannotLoadMarks: 'Cannot load marks',
    weekdays: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    tabSources: 'üì° Sources',
    sourcesTotal: 'Total', sourcesActive: 'Active', sourcesTypes: 'Types',
    addSource: '‚ûï Add Source', editSource: 'Edit', deleteSource: 'Delete',
    sourceName: 'Name', sourceType: 'Type', sourceConfig: 'Config (JSON)', sourcePublic: 'Public',
    save: 'Save', cancel: 'Cancel',
    noSources: 'No sources yet', confirmDelete: 'Delete this source?',
    lastFetched: 'Last fetched', fetchCount: 'Fetches', never: 'Never',
    sourceCreated: '‚úÖ Source created', sourceUpdated: '‚úÖ Updated', sourceDeleted: '‚úÖ Deleted',
    pasteUrl: 'üîó Paste URL to add source', detect: 'Detect', detecting: 'Detecting...', detected: 'Detected', previewRecent: 'Recent items',
    cannotDetect: 'Cannot auto-detect. ', manualAdd: 'Manual add', confirmAdd: 'Confirm',
    urlPlaceholder: 'https://...', publicSource: 'Public',
    changelog: 'Changelog',
    sharePack: 'üì¶ Share as Pack', browsePacks: 'üîç Browse Packs',
    packName: 'Pack Name', packDesc: 'Description (optional)',
    createPack: 'Create Pack', packCreated: '‚úÖ Pack created!',
    packInstalled: '‚úÖ Installed!', packAlreadyHave: 'You already have all these sources',
    installPack: 'Install', installed: 'Installed ‚úÖ', loginToInstall: 'Login to install',
    packSources: 'Sources', packInstalls: 'installs', packBy: 'By',
    deletePack: 'Delete', packDeleted: '‚úÖ Pack deleted',
    shareLink: 'Share link', copied: 'Copied!', noPacks: 'No packs yet',
    myPacks: 'My Packs', backToPacks: '‚Üê Back to Packs',
    newAdded: 'added', skipped: 'skipped (existing)',
  }
};

let lang = localStorage.getItem('digest_lang') || 'en';
function t(key) { return I18N[lang]?.[key] ?? I18N.en[key] ?? key; }

function setLang(l) {
  lang = l;
  localStorage.setItem('digest_lang', l);
  applyLang();
  renderList();
}

function applyLang() {
  document.querySelector('h1').textContent = t('title');
  document.getElementById('subtitleText').textContent = t('subtitle');
  const cl = document.getElementById('changelogLink'); if (cl) cl.textContent = t('changelog');
  document.querySelector('[data-type="4h"]').textContent = t('tab4h');
  document.querySelector('[data-type="daily"]').textContent = t('tabDaily');
  document.querySelector('[data-type="weekly"]').textContent = t('tabWeekly');
  document.querySelector('[data-type="monthly"]').textContent = t('tabMonthly');
  document.querySelector('[data-type="marks"]').textContent = t('tabMarks');
  const banner = document.getElementById('loginBanner');
  if (banner) banner.querySelector('span').textContent = t('loginBanner');
  renderAuthBar();
}

// ‚îÄ‚îÄ Changelog ‚îÄ‚îÄ
function parseChangelogMd(md) {
  return md.split('\n').map(line => {
    // headers
    if (line.startsWith('### ')) return `<h3>${esc(line.slice(4))}</h3>`;
    if (line.startsWith('## ')) return `<h2>${esc(line.slice(3))}</h2>`;
    if (line.startsWith('# ')) return `<h1>${esc(line.slice(2))}</h1>`;
    // list items with bold and code
    if (line.startsWith('- ')) {
      let content = esc(line.slice(2));
      content = content.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
      return `<li>${content}</li>`;
    }
    if (line.trim() === '') return '';
    return `<p>${esc(line)}</p>`;
  }).join('\n')
    .replace(/(<li>)/g, m => m) // wrap consecutive li in ul
    .replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
}
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function showChangelog() {
  const overlay = document.getElementById('changelogOverlay');
  const content = document.getElementById('changelogContent');
  content.innerHTML = '<p style="text-align:center;padding:40px;">‚è≥</p>';
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';
  try {
    const r = await fetch(`${API}/changelog`);
    const d = await r.json();
    content.innerHTML = parseChangelogMd(d.content);
  } catch { content.innerHTML = '<p>Failed to load changelog.</p>'; }
}
function hideChangelog() {
  document.getElementById('changelogOverlay').classList.remove('open');
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') hideChangelog(); });

// API base ‚Äî auto-detect: if served under /digest/, use /digest/api; otherwise /api
const API = (() => {
  if (location.pathname.startsWith('/digest')) return '/digest/api';
  return '/api';
})();

let currentUser = null;

let authEnabled = true;
async function checkAuth() {
  try {
    const cfg = await fetch(`${API}/auth/config`).then(r => r.json());
    authEnabled = !!cfg.authEnabled;
  } catch { authEnabled = false; }
  if (authEnabled) {
    try {
      const r = await fetch(`${API}/auth/me`, { credentials: 'same-origin' });
      if (r.ok) {
        const data = await r.json();
        currentUser = data.user;
      }
    } catch {}
  }
  renderAuthBar();
  updateMarkVisibility();
  if (currentUser && currentType === 'marks') renderMarks();
}

function ghLangHtml() {
  const label = lang === 'zh' ? 'EN' : '‰∏≠Êñá';
  return `<span class="auth-tools"><span id="langToggle" style="display:inline-flex;align-items:center;gap:4px;color:#888;cursor:pointer;font-size:12px;padding:3px 8px;border:1px solid #333;border-radius:6px;transition:all .2s;text-decoration:none;" onmouseover="this.style.borderColor='#555';this.style.color='#ccc'" onmouseout="this.style.borderColor='#333';this.style.color='#888'">üåê ${label}</span></span>`;
}

function renderAuthBar() {
  const bar = document.getElementById('authBar');
  const ghSvg = `<svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>`;
  const sourcesBtn = currentUser ? `<span onclick="currentType='sources';document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));currentOffset=0;allLoaded=false;renderSources();location.hash='sources'" style="cursor:pointer;font-size:16px;line-height:0;padding:2px;color:#666;transition:color .2s;" onmouseover="this.style.color='#ccc'" onmouseout="this.style.color='#666'" title="${t('tabSources')}">üì°</span>` : '';
  const moreMenu = `<div class="user-menu" onclick="document.getElementById('moreDropdown').classList.toggle('show')">
    <span style="cursor:pointer;font-size:14px;color:#666;transition:color .2s;padding:2px 4px;" onmouseover="this.style.color='#ccc'" onmouseout="this.style.color='#666'">‚ãØ</span>
    <div id="moreDropdown" class="user-dropdown">
      <a href="https://github.com/kevinho/ai-digest" target="_blank" onclick="event.stopPropagation();">${ghSvg} GitHub</a>
      <a href="#" onclick="event.stopPropagation();showChangelog();return false;">üìã ${t('changelog')}</a>
    </div>
  </div>`;
  if (currentUser) {
    bar.innerHTML = ghLangHtml() + sourcesBtn + moreMenu
      + `<div class="user-menu" onclick="document.getElementById('userDropdown').classList.toggle('show')">
        <img src="${currentUser.avatar}" alt="">
        <span class="user-name">${currentUser.name}</span>
        <div id="userDropdown" class="user-dropdown">
          <a href="#" onclick="event.stopPropagation();showFeedInfo();return false;">üì° My Feed</a>
          <a href="#" onclick="event.stopPropagation();doLogout();return false;">${t('logout')}</a>
        </div>
      </div>`;
  } else {
    bar.innerHTML = ghLangHtml() + moreMenu
      + (authEnabled ? `<a class="auth-btn" href="${API}/auth/google?origin=${encodeURIComponent(location.origin)}">${t('signIn')}</a>` : '');
  }
  const lt = document.getElementById('langToggle');
  if (lt) lt.onclick = (e) => { e.preventDefault(); e.stopPropagation(); setLang(lang === 'zh' ? 'en' : 'zh'); };
}

function updateMarkVisibility() {
  // Always show marks tab ‚Äî show login prompt when clicked if not logged in
  // Show/hide login banner
  const banner = document.getElementById('loginBanner');
  if (banner) {
    if (authEnabled && !currentUser && !localStorage.getItem('digest_banner_dismissed')) {
      banner.style.display = '';
      document.getElementById('bannerLogin').href = `${API}/auth/google?origin=${encodeURIComponent(location.origin)}`;
    } else {
      banner.style.display = 'none';
    }
  }
}

function dismissBanner() {
  localStorage.setItem('digest_banner_dismissed', '1');
  document.getElementById('loginBanner').style.display = 'none';
}

async function doLogout() {
  await fetch(`${API}/auth/logout`, { method: 'POST', credentials: 'same-origin' });
  currentUser = null;
  renderAuthBar();
  updateMarkVisibility();
  if (currentType === 'marks') {
    renderList(); // Will show login prompt
  }
}

function WEEKDAYS() { return t('weekdays'); }
let currentType = '4h';
let markedUrls = new Set();
const PAGE_SIZE = 10;
let currentOffset = 0;
let allLoaded = false;

function parseCreatedAt(d) {
  const ca = d.created_at;
  // Handle week format: "2026-W07"
  if (/^\d{4}-W\d{2}$/.test(ca)) {
    const [y, w] = ca.split('-W').map(Number);
    // Approximate: week 1 starts Jan 1
    const jan1 = new Date(y, 0, 1);
    return new Date(jan1.getTime() + (w - 1) * 7 * 86400000);
  }
  // Handle month format: "2026-02"
  if (/^\d{4}-\d{2}$/.test(ca)) {
    return new Date(ca + '-01T00:00:00+08:00');
  }
  // Handle year format: "2026"
  if (/^\d{4}$/.test(ca)) {
    return new Date(ca + '-01-01T00:00:00+08:00');
  }
  return new Date(ca.replace(' ', 'T') + (ca.includes('+') ? '' : '+08:00'));
}

function getWeekKey(dt) {
  const d = new Date(dt); d.setHours(0,0,0,0);
  const jan1 = new Date(d.getFullYear(), 0, 1);
  const days = Math.floor((d - jan1) / 86400000);
  const week = Math.ceil((days + jan1.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${String(week).padStart(2, '0')}`;
}

function groupDigests(digests) {
  const groups = {}; const order = [];
  function localDateStr(dt) { return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`; }
  function localMonthStr(dt) { return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`; }
  for (const d of digests) {
    const dt = parseCreatedAt(d);
    let key;
    if (currentType === '4h') {
      key = localDateStr(dt); // by local day
    } else if (currentType === 'daily') {
      key = getWeekKey(dt); // by week
    } else if (currentType === 'weekly') {
      key = localMonthStr(dt); // by local month
    } else {
      key = String(dt.getFullYear()); // by local year
    }
    if (!groups[key]) { groups[key] = []; order.push(key); }
    groups[key].push({ ...d, _dt: dt });
  }
  return { groups, order };
}

function formatGroupLabel(type, key) {
  if (type === '4h') {
    const d = new Date(key + 'T00:00:00+08:00');
    const wd = WEEKDAYS()[d.getDay()];
    const today = new Date(); today.setHours(0,0,0,0);
    const diff = Math.round((today - new Date(d.toDateString())) / 86400000);
    if (diff === 0) return `üìÖ ${t('today')} ¬∑ ${key} ${wd}`;
    if (diff === 1) return `üìÖ ${t('yesterday')} ¬∑ ${key} ${wd}`;
    return `üìÖ ${key} ${wd}`;
  }
  if (type === 'daily') {
    const [y, w] = key.split('-W');
    return t('weekLabel')(y, parseInt(w));
  }
  if (type === 'weekly') {
    const [y, m] = key.split('-');
    return t('monthLabel')(y, parseInt(m));
  }
  if (type === 'monthly') {
    return t('yearLabel')(key);
  }
  return `üìÖ ${key}`;
}

function extractExcerpt(content) {
  if (!content) return '';
  const lines = content.split('\n');
  const highlights = [];
  let inImportant = false;
  for (const line of lines) {
    const trimmed = line.trim();
    // Detect üî•ÈáçË¶Å section
    if (trimmed.includes('üî•')) { inImportant = true; continue; }
    // Stop at next section header
    if (inImportant && (trimmed.startsWith('üì∞') || trimmed.startsWith('üîñ') || trimmed.startsWith('üîç') || trimmed.startsWith('üëÄ') || trimmed.startsWith('üßπ') || trimmed.startsWith('üí§'))) break;
    if (inImportant && trimmed.startsWith('‚Ä¢')) {
      let clean = trimmed.replace(/^‚Ä¢\s*/, '').replace(/\*\*/g, '').replace(/https?:\/\/\S+/g, '').replace(/ÔºàÊù•Ê∫ê[^Ôºâ]*Ôºâ/g, '').trim();
      if (clean.length > 8) highlights.push(clean.length > 80 ? clean.slice(0, 80) + '‚Ä¶' : clean);
      if (highlights.length >= 2) break;
    }
  }
  if (highlights.length) return highlights.join(' ¬∑ ');
  // Fallback: find first bullet with substance
  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#') || trimmed.startsWith('>') || trimmed === '---' || /^[‚òÄÔ∏èüî•üì∞üìÖ]/.test(trimmed) || trimmed.startsWith('*Âü∫‰∫é')) continue;
    let clean = trimmed.replace(/^[‚Ä¢\-\*]\s*/, '').replace(/\*\*/g, '').replace(/https?:\/\/\S+/g, '').trim();
    if (clean.length > 15) return clean.length > 120 ? clean.slice(0, 120) + '‚Ä¶' : clean;
  }
  return '';
}

let loadedDigests = [];

function goHome() {
  currentType = '4h';
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector('[data-type="4h"]').classList.add('active');
  currentOffset = 0; allLoaded = false;
  renderList(); location.hash = '4h';
}

async function renderList(append = false) {
  const list = document.getElementById('list');
  const viewer = document.getElementById('viewer');
  viewer.style.display = 'none';

  if (currentType === 'marks') { renderMarks(); return; }
  if (currentType === 'sources') { renderSources(); return; }

  if (!append) {
    currentOffset = 0;
    allLoaded = false;
    loadedDigests = [];
    list.innerHTML = `<div class="loading">${t('loading')}</div>`;
  }

  try {
    const resp = await fetch(`${API}/digests?type=${currentType}&limit=${PAGE_SIZE}&offset=${currentOffset}`);
    const digests = await resp.json();
    if (digests.length < PAGE_SIZE) allLoaded = true;
    loadedDigests = loadedDigests.concat(digests);
    currentOffset += digests.length;

    if (!loadedDigests.length) { list.innerHTML = `<div class="empty">${t('noData')}</div>`; return; }

    const { groups, order } = groupDigests(loadedDigests);
    let html = '';
    for (const gk of order) {
      const items = groups[gk];
      const label = formatGroupLabel(currentType, gk);
      html += `<div class="date-group"><div class="date-group-header">${label} <span class="count">${items.length} ${t('articles')}</span></div><div class="date-group-items">`;
      for (const d of items) {
        const dt = d._dt;
        const time = dt.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
        let title, badge;
        if (currentType === '4h') {
          title = `${time} SGT`; badge = `<span class="time-badge">${time}</span>`;
        } else if (currentType === 'daily') {
          const dateStr = dt.toISOString().slice(0, 10);
          const wd = WEEKDAYS()[dt.getDay()];
          title = `${dateStr} ${wd}`; badge = '';
        } else if (currentType === 'weekly') {
          const wk = getWeekKey(dt);
          title = `Á¨¨ ${parseInt(wk.split('-W')[1])} Âë®`; badge = '';
        } else {
          const mon = dt.toISOString().slice(0, 7);
          title = `${parseInt(mon.split('-')[1])} Êúà`; badge = '';
        }
        const excerpt = extractExcerpt(d.content);
        html += `<div class="digest-card" data-id="${d.id}"><div class="card-body"><div class="title">${title}</div>${excerpt ? `<div class="excerpt">${excerpt}</div>` : ''}</div>${badge}</div>`;
      }
      html += `</div></div>`;
    }
    if (!allLoaded) {
      html += `<div id="load-more" style="text-align:center;padding:16px;"><button onclick="loadMore()" style="padding:10px 32px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#aaa;cursor:pointer;font-size:14px;transition:all .2s;">${t('loadMore')}</button></div>`;
    }
    list.innerHTML = html;
    list.querySelectorAll('.digest-card').forEach(card => {
      card.onclick = () => loadDigest(card.dataset.id);
    });
  } catch (e) {
    if (!append) list.innerHTML = `<div class="empty">${t('loadFail')}: ${e.message}</div>`;
  }
}

// (smart add is rendered inside renderSources)

async function loadMore() {
  const btn = document.querySelector('#load-more button');
  if (btn) { btn.textContent = t('loadingMore'); btn.disabled = true; }
  await renderList(true);
}

async function loadDigest(id) {
  const list = document.getElementById('list');
  const viewer = document.getElementById('viewer');
  list.innerHTML = '';
  try {
    const resp = await fetch(`${API}/digests/${id}`);
    const d = await resp.json();
    let text = d.content;
    // Hide private sections for non-logged-in users
    if (!currentUser) {
      text = text.replace(/üßπ\s*Âª∫ËÆÆÂèñÂÖ≥[\s\S]*?(?=\n(?:üí§|üîç|üëÄ|üì∞|üîñ|üî•|‚Äî|$))/g, '');
      text = text.replace(/üîñ\s*Bookmarks\s*Á≤æÈÄâ[\s\S]*?(?=\n(?:üí§|üîç|üëÄ|üì∞|üßπ|üî•|‚Äî|$))/g, '');
    }
    await loadMarkedUrls();

    text = text.replace(/(https?:\/\/x\.com\/[^\s<)]+)/g, (match) => {
      const clean = match.split('?')[0];
      const isMarked = markedUrls.has(clean);
      let markHtml;
      if (currentUser) {
        markHtml = `<span class="mark-btn ${isMarked ? 'marked' : ''}" onclick="doMark('${clean}', this)">${isMarked ? t('marked') : t('mark')}</span>`;
      } else {
        markHtml = `<span class="mark-btn disabled" onclick="showToast('${t('loginToMark')}')" title="${t('loginToMark')}">${t('mark')}</span>`;
      }
      return `<a href="${match}" target="_blank">${match}</a>${markHtml}`;
    });
    text = text.replace(/(https?:\/\/(?!x\.com)[^\s<)]+)/g, '<a href="$1" target="_blank">$1</a>');

    viewer.innerHTML = `<div class="back-btn" onclick="renderList()">${t('back')}</div>\n${text}`;
    viewer.style.display = 'block';
  } catch (e) {
    viewer.innerHTML = `<div class="back-btn" onclick="renderList()">${t('back')}</div>\n<div class="empty">${t('cantLoad')}</div>`;
    viewer.style.display = 'block';
  }
}

let markViewMode = 'topic'; // 'topic' or 'time'

function getMarkTopic(m) {
  return m.title || 'ÂÖ∂‰ªñ';
}

async function renderMarks() {
  const list = document.getElementById('list');
  if (!currentUser) {
    list.innerHTML = authEnabled ? `<div class="login-prompt">
      <div class="icon">üîê</div>
      <div class="msg">${t('loginPromptTitle')}<br>${t('loginPromptDesc')}</div>
      <a class="auth-btn" href="${API}/auth/google?origin=${encodeURIComponent(location.origin)}">${t('signIn')}</a>
    </div>` : `<div class="login-prompt"><div class="icon">üîê</div><div class="msg">${t('loginPromptTitle')}</div></div>`;
    return;
  }
  list.innerHTML = `<div class="loading">${t('loading')}</div>`;
  try {
    const resp = await fetch(`${API}/marks`, { credentials: 'same-origin' });
    const marks = await resp.json();
    const pending = marks.filter(m => m.status === 'pending');
    const processed = marks.filter(m => m.status === 'processed');

    let html = `<div class="mark-stats">
      <div class="mark-stat"><div class="num">${marks.length}</div><div class="label">${t('totalMarks')}</div></div>
      <div class="mark-stat"><div class="num">${processed.length}</div><div class="label">${t('deepDived')}</div></div>
      <div class="mark-stat"><div class="num" style="color:#f0b040">${pending.length}</div><div class="label">${t('pending')}</div></div>
    </div>`;

    // View toggle
    html += `<div style="display:flex;gap:8px;margin-bottom:16px;">
      <div class="tab ${markViewMode==='topic'?'active':''}" onclick="markViewMode='topic';renderMarks()">${t('byTopic')}</div>
      <div class="tab ${markViewMode==='time'?'active':''}" onclick="markViewMode='time';renderMarks()">${t('byTime')}</div>
    </div>`;

    if (!marks.length) {
      html += `<div class="empty">${t('noMarks')}</div>`;
    } else if (markViewMode === 'topic') {
      // Group by topic
      const topicGroups = {};
      for (const m of marks) {
        const topic = getMarkTopic(m);
        if (!topicGroups[topic]) topicGroups[topic] = [];
        topicGroups[topic].push(m);
      }
      // Sort topics by count desc
      const sortedTopics = Object.entries(topicGroups).sort((a,b) => b[1].length - a[1].length);
      for (const [topic, items] of sortedTopics) {
        html += `<div class="date-group"><div class="date-group-header">${topic} <span class="count">${items.length} ${t('items')}</span></div><div class="date-group-items">`;
        for (const m of items) html += renderMarkCard(m);
        html += `</div></div>`;
      }
    } else {
      // Group by date
      const dateGroups = {}; const dateOrder = [];
      for (const m of marks) {
        const dt = new Date(m.created_at);
        const key = dt.toISOString().slice(0, 10);
        if (!dateGroups[key]) { dateGroups[key] = []; dateOrder.push(key); }
        dateGroups[key].push(m);
      }
      for (const key of dateOrder) {
        const items = dateGroups[key];
        html += `<div class="date-group"><div class="date-group-header">üìÖ ${key} <span class="count">${items.length} ${t('items')}</span></div><div class="date-group-items">`;
        for (const m of items) html += renderMarkCard(m);
        html += `</div></div>`;
      }
    }
    list.innerHTML = html;
  } catch (e) {
    list.innerHTML = `<div class="empty">${t('cannotLoadMarks')}</div>`;
  }
}

function renderMarkCard(m) {
  const authorMatch = m.url.match(/x\.com\/([^/]+)/);
  const author = authorMatch ? authorMatch[1] : '?';
  const isDone = m.status === 'processed';
  const topic = getMarkTopic(m);
  const summary = m.note || '';
  return `<div class="mark-card">
    <div class="mark-meta">
      <span class="mark-author">@${author}</span>
      <span class="mark-status ${isDone ? 'done' : 'pending'}">${isDone ? t('marksDone') : t('marksPending')}</span>
    </div>
    ${summary ? `<div style="font-size:13px;color:#bbb;margin:6px 0;line-height:1.5;">${summary}</div>` : ''}
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
      <a href="${m.url}" target="_blank" style="font-size:12px;color:#555;text-decoration:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;">${m.url.replace('https://x.com/','x.com/')}</a>
      <span style="font-size:11px;color:#555;background:#1a1a1a;padding:1px 6px;border-radius:3px;border:1px solid #282828;">${topic}</span>
    </div>
  </div>`;
}

const SOURCE_ICONS = { twitter_feed: 'üê¶', twitter_list: 'üê¶', rss: 'üì°', website: 'üåê', hackernews: 'üî∂', reddit: 'üëΩ', github_trending: '‚≠ê', custom_api: 'üîå', digest_feed: 'üì∞' };
const SOURCE_TYPES = ['twitter_feed', 'twitter_list', 'rss', 'website', 'hackernews', 'reddit', 'github_trending', 'custom_api', 'digest_feed'];
let showSourceForm = false;
let editingSource = null;

async function renderSources() {
  const list = document.getElementById('list');
  list.innerHTML = `<div class="loading">${t('loading')}</div>`;
  try {
    const resp = await fetch(`${API}/sources`, { credentials: 'same-origin' });
    const sources = await resp.json();
    const isLoggedIn = !!currentUser;
    const active = sources.filter(s => s.is_active);
    const types = [...new Set(sources.map(s => s.type))];

    let html = `<div class="mark-stats">
      <div class="mark-stat"><div class="num">${sources.length}</div><div class="label">${t('sourcesTotal')}</div></div>
      <div class="mark-stat"><div class="num" style="color:#40c040">${active.length}</div><div class="label">${t('sourcesActive')}</div></div>
      <div class="mark-stat"><div class="num">${types.length}</div><div class="label">${t('sourcesTypes')}</div></div>
    </div>`;

    // Pack buttons
    if (isLoggedIn) {
      html += `<div style="display:flex;gap:8px;margin-bottom:16px;">
        <button onclick="showCreatePackModal()" style="padding:8px 16px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#aaa;cursor:pointer;font-size:13px;transition:all .2s;" onmouseover="this.style.borderColor='#666';this.style.color='#fff'" onmouseout="this.style.borderColor='#444';this.style.color='#aaa'">${t('sharePack')}</button>
        <button onclick="renderPacksSection()" style="padding:8px 16px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#aaa;cursor:pointer;font-size:13px;transition:all .2s;" onmouseover="this.style.borderColor='#666';this.style.color='#fff'" onmouseout="this.style.borderColor='#444';this.style.color='#aaa'">${t('browsePacks')}</button>
      </div>`;
    }

    if (isLoggedIn) {
      html += `<div id="smartAddContainer"></div>`;
      html += `<div id="sourceFormContainer"></div>`;
    }

    if (!sources.length) {
      html += `<div class="empty">${t('noSources')}</div>`;
    } else {
      html += '<div class="digest-list">';
      for (const s of sources) {
        const icon = SOURCE_ICONS[s.type] || 'üì¶';
        const lastFetch = s.last_fetched_at ? s.last_fetched_at.slice(0, 16).replace('T', ' ') : t('never');
        html += `<div class="source-card">
          <div class="source-header">
            <span class="source-name">${icon} ${s.name}${s.is_public ? ' <span style="font-size:11px;color:#666;font-weight:400;">üåê</span>' : ''}</span>
            <div class="source-actions">
              ${(currentUser && s.created_by === currentUser.id) ? `<label class="toggle-switch" title="Active"><input type="checkbox" ${s.is_active ? 'checked' : ''} onchange="toggleSource(${s.id}, this.checked)"><span class="toggle-slider"></span></label>
              <button onclick="editSourceForm(${s.id})">${t('editSource')}</button>
              <button class="danger" onclick="delSource(${s.id})">${t('deleteSource')}</button>` : ''}
            </div>
          </div>
          <div class="source-meta">
            <span>${s.type}</span>
            <span>${t('lastFetched')}: ${lastFetch}</span>
            <span>${t('fetchCount')}: ${s.fetch_count}</span>
          </div>
        </div>`;
      }
      html += '</div>';
    }
    list.innerHTML = html;
    renderSmartAdd();
    if (showSourceForm) renderSourceForm();
  } catch (e) {
    list.innerHTML = `<div class="empty">Failed: ${e.message}</div>`;
  }
}

let resolvedSource = null;
let smartAddState = 'input'; // 'input' | 'loading' | 'preview' | 'error'
let smartAddError = '';

function renderSmartAdd() {
  const container = document.getElementById('smartAddContainer');
  if (!container) return;

  let html = `<div class="source-form" style="margin-bottom:16px;">`;
  html += `<div style="font-size:13px;color:#888;margin-bottom:10px;">${t('pasteUrl')}</div>`;
  html += `<div style="display:flex;gap:8px;">
    <input id="smart_url" type="url" placeholder="${t('urlPlaceholder')}" style="flex:1;padding:8px 12px;background:#0f0f0f;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:13px;" value="${document.getElementById('smart_url')?.value || ''}" onkeydown="if(event.key==='Enter')detectSource()">
    <button onclick="detectSource()" id="detectBtn" style="padding:8px 18px;background:#1a3a1a;border:1px solid #40c040;border-radius:8px;color:#40c040;cursor:pointer;font-size:13px;white-space:nowrap;transition:all .2s;" ${smartAddState==='loading'?'disabled':''}>${smartAddState==='loading' ? t('detecting') : t('detect')}</button>
  </div>`;

  if (smartAddState === 'preview' && resolvedSource) {
    html += `<div style="margin-top:14px;padding:14px;background:#0f0f0f;border:1px solid #333;border-radius:8px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <span style="font-size:18px;">${resolvedSource.icon || 'üì¶'}</span>
        <span style="font-size:12px;color:#888;background:#1a1a1a;padding:2px 8px;border-radius:4px;border:1px solid #282828;">${resolvedSource.type}</span>
      </div>
      <div style="margin-bottom:8px;">
        <span id="resolvedName" style="font-size:15px;font-weight:600;cursor:pointer;border-bottom:1px dashed #555;" onclick="this.contentEditable=true;this.focus();this.style.borderBottom='1px solid #40c040'" onblur="this.contentEditable=false;this.style.borderBottom='1px dashed #555';resolvedSource.name=this.textContent.trim()">${resolvedSource.name}</span>
      </div>
      <div style="font-size:12px;color:#555;margin-bottom:8px;word-break:break-all;">${document.getElementById('smart_url')?.value || ''}</div>
      ${resolvedSource.preview && resolvedSource.preview.length ? `<div style="margin-bottom:12px;padding:10px;background:#141414;border-radius:6px;border:1px solid #222;">
        <div style="font-size:11px;color:#666;margin-bottom:6px;">üìÑ ${t('previewRecent')}</div>
        ${resolvedSource.preview.slice(0,5).map(p => `<div style="font-size:12px;color:#aaa;padding:2px 0;line-height:1.5;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.url ? `<a href="${p.url}" target="_blank" style="color:#58a6ff;text-decoration:none;" title="${p.title}">` : ''}‚Ä¢ ${p.title}${p.url ? '</a>' : ''}</div>`).join('')}
      </div>` : ''}
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#888;cursor:pointer;">
          <input type="checkbox" id="smart_public" style="width:14px;height:14px;"> ${t('publicSource')}
        </label>
        <div style="display:flex;gap:8px;">
          <button onclick="confirmSmartAdd()" style="padding:8px 18px;background:#1a3a1a;border:1px solid #40c040;border-radius:8px;color:#40c040;cursor:pointer;font-size:13px;">‚úì ${t('confirmAdd')}</button>
          <button onclick="smartAddState='input';resolvedSource=null;renderSmartAdd()" style="padding:8px 18px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#aaa;cursor:pointer;font-size:13px;">${t('cancel')}</button>
        </div>
      </div>
    </div>`;
  }

  if (smartAddState === 'error') {
    html += `<div style="margin-top:10px;font-size:12px;color:#f04040;">${t('cannotDetect')}<a href="#" onclick="event.preventDefault();toggleSourceForm()" style="color:#58a6ff;">${t('manualAdd')} ‚Ä∫</a></div>`;
  } else {
    html += `<div style="margin-top:8px;"><a href="#" onclick="event.preventDefault();toggleSourceForm()" style="font-size:12px;color:#555;text-decoration:none;">${t('manualAdd')} ‚Ä∫</a></div>`;
  }

  html += `</div>`;
  container.innerHTML = html;
}

async function detectSource() {
  const input = document.getElementById('smart_url');
  const url = (input?.value || '').trim();
  if (!url) return;
  smartAddState = 'loading';
  resolvedSource = null;
  renderSmartAdd();
  try {
    const r = await fetch(`${API}/sources/resolve`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ url }) });
    const data = await r.json();
    if (!r.ok) throw new Error(data.error || 'failed');
    resolvedSource = data;
    smartAddState = 'preview';
  } catch (e) {
    smartAddState = 'error';
    smartAddError = e.message;
  }
  renderSmartAdd();
}

async function confirmSmartAdd() {
  if (!resolvedSource) return;
  const isPublic = document.getElementById('smart_public')?.checked || false;
  try {
    await fetch(`${API}/sources`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin',
      body: JSON.stringify({ name: resolvedSource.name, type: resolvedSource.type, config: JSON.stringify(resolvedSource.config), isPublic }) });
    showToast(t('sourceCreated'));
    smartAddState = 'input'; resolvedSource = null;
    renderSources();
  } catch (e) { showToast('Error: ' + e.message); }
}

function toggleSourceForm() {
  showSourceForm = !showSourceForm;
  editingSource = null;
  renderSourceForm();
}

async function editSourceForm(id) {
  try {
    const r = await fetch(`${API}/sources/${id}`, { credentials: 'same-origin' });
    editingSource = await r.json();
    showSourceForm = true;
    renderSourceForm();
  } catch {}
}

const SOURCE_EXAMPLES = {
  twitter_feed: { handle: "@elonmusk", keywords: ["AI", "LLM"] },
  twitter_list: { list_url: "https://x.com/i/lists/123456789" },
  rss: { url: "https://hnrss.org/frontpage" },
  website: { url: "https://news.ycombinator.com", selector: ".titleline > a" },
  hackernews: { filter: "top", min_score: 100 },
  reddit: { subreddit: "MachineLearning", sort: "hot", limit: 20 },
  github_trending: { language: "python", since: "daily" },
  custom_api: { endpoint: "https://api.example.com/feed", headers: { "Authorization": "Bearer xxx" } },
  digest_feed: { url: "https://digest.kevinhe.io/feed/kevin.json" }
};

function showFeedInfo() {
  document.getElementById('userDropdown').classList.remove('show');
  if (!currentUser) return;
  // Fetch user slug from /api/auth/me (slug is included)
  fetch(`${API}/auth/me`, { credentials: 'same-origin' }).then(r => r.json()).then(data => {
    const slug = data.user.slug || 'unknown';
    const base = location.origin;
    const jsonUrl = `${base}/feed/${slug}.json`;
    const rssUrl = `${base}/feed/${slug}.rss`;
    const apiUrl = `${base}/feed/${slug}`;
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:center;justify-content:center;';
    modal.onclick = e => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `<div style="background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:24px;max-width:480px;width:90%;">
      <h3 style="margin:0 0 16px;font-size:16px;">üì° Your Feed</h3>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px;color:#888;">JSON Feed</label>
        <div style="display:flex;gap:6px;margin-top:4px;"><input readonly value="${jsonUrl}" style="flex:1;padding:6px 10px;background:#0f0f0f;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:12px;" onclick="this.select()"><button onclick="navigator.clipboard.writeText('${jsonUrl}');showToast('Copied!')" style="padding:6px 12px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#aaa;cursor:pointer;font-size:12px;">üìã</button></div>
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px;color:#888;">RSS Feed</label>
        <div style="display:flex;gap:6px;margin-top:4px;"><input readonly value="${rssUrl}" style="flex:1;padding:6px 10px;background:#0f0f0f;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:12px;" onclick="this.select()"><button onclick="navigator.clipboard.writeText('${rssUrl}');showToast('Copied!')" style="padding:6px 12px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#aaa;cursor:pointer;font-size:12px;">üìã</button></div>
      </div>
      <div style="margin-bottom:16px;">
        <label style="font-size:12px;color:#888;">Simple API</label>
        <div style="display:flex;gap:6px;margin-top:4px;"><input readonly value="${apiUrl}" style="flex:1;padding:6px 10px;background:#0f0f0f;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:12px;" onclick="this.select()"><button onclick="navigator.clipboard.writeText('${apiUrl}');showToast('Copied!')" style="padding:6px 12px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#aaa;cursor:pointer;font-size:12px;">üìã</button></div>
      </div>
      <div style="text-align:right;"><button onclick="this.closest('div[style*=fixed]').remove()" style="padding:8px 20px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#aaa;cursor:pointer;font-size:13px;">Close</button></div>
    </div>`;
    document.body.appendChild(modal);
  });
}

function onTypeChange() {
  const sel = document.getElementById('sf_type');
  const ta = document.getElementById('sf_config');
  if (!sel || !ta) return;
  if (editingSource) return; // don't overwrite when editing
  ta.value = JSON.stringify(SOURCE_EXAMPLES[sel.value] || {}, null, 2);
}

function renderSourceForm() {
  const container = document.getElementById('sourceFormContainer');
  if (!container) return;
  if (!showSourceForm) { container.innerHTML = ''; return; }
  const s = editingSource;
  const typeOptions = SOURCE_TYPES.map(t => `<option value="${t}" ${s && s.type === t ? 'selected' : ''}>${SOURCE_ICONS[t] || ''} ${t}</option>`).join('');
  const configVal = s ? (typeof s.config === 'string' ? s.config : JSON.stringify(JSON.parse(s.config), null, 2)) : JSON.stringify(SOURCE_EXAMPLES['twitter_feed'], null, 2);
  container.innerHTML = `<div class="source-form">
    <div class="form-row"><label>${t('sourceName')}</label><input id="sf_name" value="${s ? s.name : ''}" placeholder="e.g. AI Twitter Feed"></div>
    <div class="form-row"><label>${t('sourceType')}</label><select id="sf_type" onchange="onTypeChange()">${typeOptions}</select></div>
    <div class="form-row"><label>${t('sourceConfig')}</label><textarea id="sf_config" style="font-family:monospace;font-size:12px;min-height:100px;">${configVal}</textarea></div>
    <div class="form-row" style="flex-direction:row;align-items:center;gap:10px;"><label style="cursor:pointer;display:flex;align-items:center;gap:6px;margin:0;"><input type="checkbox" id="sf_public" style="width:16px;height:16px;" ${s && s.is_public ? 'checked' : ''}> ${t('sourcePublic')}</label></div>
    <div class="form-actions">
      <button class="primary" onclick="saveSource()">${t('save')}</button>
      <button onclick="showSourceForm=false;editingSource=null;renderSourceForm()">${t('cancel')}</button>
    </div>
  </div>`;
}

async function saveSource() {
  const name = document.getElementById('sf_name').value.trim();
  const type = document.getElementById('sf_type').value;
  const config = document.getElementById('sf_config').value.trim();
  const isPublic = document.getElementById('sf_public').checked;
  if (!name) return;
  try { JSON.parse(config); } catch { showToast('Invalid JSON config'); return; }
  try {
    if (editingSource) {
      await fetch(`${API}/sources/${editingSource.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ name, type, config, isPublic }) });
      showToast(t('sourceUpdated'));
    } else {
      await fetch(`${API}/sources`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ name, type, config, isPublic }) });
      showToast(t('sourceCreated'));
    }
    showSourceForm = false; editingSource = null;
    renderSources();
  } catch (e) { showToast('Error: ' + e.message); }
}

async function toggleSource(id, active) {
  await fetch(`${API}/sources/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ isActive: active }) });
}

async function delSource(id) {
  if (!confirm(t('confirmDelete'))) return;
  await fetch(`${API}/sources/${id}`, { method: 'DELETE', credentials: 'same-origin' });
  showToast(t('sourceDeleted'));
  renderSources();
}

async function loadMarkedUrls() {
  if (!currentUser) return;
  try {
    const r = await fetch(`${API}/marks`, { credentials: 'same-origin' });
    if (r.ok) {
      const marks = await r.json();
      marks.forEach(m => markedUrls.add(m.url));
    }
  } catch {}
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

async function doMark(url, btn) {
  try {
    const r = await fetch(`${API}/marks`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ url })
    });
    const d = await r.json();
    if (d.ok) {
      markedUrls.add(url);
      btn.textContent = t('marked');
      btn.classList.add('marked');
      btn.onclick = null;
      showToast(d.duplicate ? t('markDup') : t('markSuccess'));
    }
  } catch (e) { showToast(t('markFail') + ': ' + e.message); }
}

// ‚îÄ‚îÄ Source Packs ‚îÄ‚îÄ

let packsViewMode = 'browse'; // 'browse' | 'detail'
let currentPackSlug = null;

async function renderPacksSection() {
  const list = document.getElementById('list');
  list.innerHTML = `<div class="loading">${t('loading')}</div>`;
  try {
    const r = await fetch(`${API}/packs`, { credentials: 'same-origin' });
    const packs = await r.json();
    let html = `<div style="display:flex;gap:8px;margin-bottom:16px;">
      <button onclick="renderSources()" class="back-btn">${t('back')}</button>
    </div>`;
    if (!packs.length) {
      html += `<div class="empty">${t('noPacks')}</div>`;
    } else {
      html += '<div class="digest-list">';
      for (const p of packs) {
        const sources = p.sources || [];
        html += `<div class="pack-card">
          <div class="pack-header">
            <div style="flex:1;">
              <div class="pack-name">üì¶ ${esc(p.name)}</div>
              ${p.description ? `<div class="pack-desc">${esc(p.description)}</div>` : ''}
              <div class="pack-sources-list">
                ${sources.slice(0, 8).map(s => `<span class="pack-source-tag">${SOURCE_ICONS[s.type] || 'üì¶'} ${esc(s.name)}</span>`).join('')}
                ${sources.length > 8 ? `<span class="pack-source-tag">+${sources.length - 8}</span>` : ''}
              </div>
              <div class="pack-meta">
                ${p.creator_avatar ? `<img src="${p.creator_avatar}" alt="">` : ''}
                <span>${p.creator_name || 'Anonymous'}</span>
                <span>¬∑</span>
                <span>${sources.length} ${t('packSources')}</span>
                <span>¬∑</span>
                <span>${p.install_count} ${t('packInstalls')}</span>
              </div>
            </div>
            <div class="pack-actions">
              ${currentUser ? `<button class="pack-install-btn" onclick="installPack('${p.slug}', this)">${t('installPack')}</button>` : `<button class="pack-install-btn" onclick="showToast(t('loginToInstall'))" style="opacity:.5">${t('loginToInstall')}</button>`}
              ${currentUser && p.created_by === currentUser.id ? `<button class="pack-delete-btn" onclick="delPack(${p.id})">${t('deletePack')}</button>` : ''}
            </div>
          </div>
        </div>`;
      }
      html += '</div>';
    }
    list.innerHTML = html;
  } catch (e) {
    list.innerHTML = `<div class="empty">Failed: ${e.message}</div>`;
  }
}

async function installPack(slug, btn) {
  if (btn.classList.contains('done')) return;
  btn.disabled = true;
  btn.textContent = '...';
  try {
    const r = await fetch(`${API}/packs/${slug}/install`, { method: 'POST', credentials: 'same-origin' });
    const d = await r.json();
    if (d.ok) {
      btn.textContent = t('installed');
      btn.classList.add('done');
      let msg = t('packInstalled');
      if (d.added > 0) msg += ` ${d.added} ${t('newAdded')}`;
      if (d.skipped > 0) msg += `, ${d.skipped} ${t('skipped')}`;
      showToast(msg);
    } else {
      showToast(d.error || 'Error');
      btn.textContent = t('installPack');
      btn.disabled = false;
    }
  } catch (e) {
    showToast('Error: ' + e.message);
    btn.textContent = t('installPack');
    btn.disabled = false;
  }
}

async function delPack(id) {
  if (!confirm(t('confirmDelete'))) return;
  await fetch(`${API}/packs/${id}`, { method: 'DELETE', credentials: 'same-origin' });
  showToast(t('packDeleted'));
  renderPacksSection();
}

function showCreatePackModal() {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:center;justify-content:center;';
  modal.onclick = e => { if (e.target === modal) modal.remove(); };
  modal.innerHTML = `<div style="background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:24px;max-width:480px;width:90%;">
    <h3 style="margin:0 0 16px;font-size:16px;">üì¶ ${t('sharePack')}</h3>
    <div style="margin-bottom:12px;">
      <label style="font-size:12px;color:#888;">${t('packName')}</label>
      <input id="pack_name" style="width:100%;padding:8px 12px;background:#0f0f0f;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:13px;margin-top:4px;" placeholder="${currentUser ? currentUser.name + "'s AI Sources" : 'My AI Sources'}" value="${currentUser ? currentUser.name + "'s AI Sources" : ''}">
    </div>
    <div style="margin-bottom:16px;">
      <label style="font-size:12px;color:#888;">${t('packDesc')}</label>
      <textarea id="pack_desc" style="width:100%;padding:8px 12px;background:#0f0f0f;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:13px;margin-top:4px;min-height:60px;resize:vertical;font-family:inherit;" placeholder="A curated set of AI news sources..."></textarea>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:8px 20px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#aaa;cursor:pointer;font-size:13px;">${t('cancel')}</button>
      <button onclick="doCreatePack(this)" style="padding:8px 20px;background:#1a3a1a;border:1px solid #40c040;border-radius:6px;color:#40c040;cursor:pointer;font-size:13px;">${t('createPack')}</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
  document.getElementById('pack_name').focus();
}

async function doCreatePack(btn) {
  const nameEl = document.getElementById('pack_name');
  const name = nameEl.value.trim() || nameEl.placeholder || 'My AI Sources';
  const description = document.getElementById('pack_desc').value.trim();
  btn.disabled = true;
  btn.textContent = '...';
  try {
    // Get user's active sources
    const sr = await fetch(`${API}/sources`, { credentials: 'same-origin' });
    const sources = await sr.json();
    const mySources = sources.filter(s => currentUser && s.created_by === currentUser.id && s.is_active);
    if (!mySources.length) { showToast('No active sources to share'); btn.disabled = false; btn.textContent = t('createPack'); return; }
    const sourcesJson = JSON.stringify(mySources.map(s => ({ name: s.name, type: s.type, config: typeof s.config === 'string' ? JSON.parse(s.config) : s.config })));
    const r = await fetch(`${API}/packs`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin',
      body: JSON.stringify({ name, description, sourcesJson }) });
    const d = await r.json();
    if (d.slug) {
      btn.closest('div[style*=fixed]').remove();
      showToast(t('packCreated'));
      // Show share link
      const shareUrl = `${location.origin}/pack/${d.slug}`;
      const linkModal = document.createElement('div');
      linkModal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:center;justify-content:center;';
      linkModal.onclick = e => { if (e.target === linkModal) linkModal.remove(); };
      linkModal.innerHTML = `<div style="background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:24px;max-width:480px;width:90%;">
        <h3 style="margin:0 0 16px;font-size:16px;">üîó ${t('shareLink')}</h3>
        <div style="display:flex;gap:6px;"><input readonly value="${shareUrl}" style="flex:1;padding:8px 12px;background:#0f0f0f;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:13px;" onclick="this.select()"><button onclick="navigator.clipboard.writeText('${shareUrl}');showToast(t('copied'))" style="padding:8px 14px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#aaa;cursor:pointer;font-size:13px;">üìã</button></div>
        <div style="text-align:right;margin-top:16px;"><button onclick="this.closest('div[style*=fixed]').remove()" style="padding:8px 20px;background:#2a2a2a;border:1px solid #444;border-radius:6px;color:#aaa;cursor:pointer;font-size:13px;">Close</button></div>
      </div>`;
      document.body.appendChild(linkModal);
    } else {
      showToast(d.error || 'Error');
      btn.disabled = false; btn.textContent = t('createPack');
    }
  } catch (e) { showToast('Error: ' + e.message); btn.disabled = false; btn.textContent = t('createPack'); }
}

async function renderPackDetailPage(slug) {
  const list = document.getElementById('list');
  const viewer = document.getElementById('viewer');
  viewer.style.display = 'none';
  list.innerHTML = `<div class="loading">${t('loading')}</div>`;
  try {
    const r = await fetch(`${API}/packs/${slug}`, { credentials: 'same-origin' });
    if (!r.ok) { list.innerHTML = `<div class="empty">Pack not found</div>`; return; }
    const p = await r.json();
    const sources = p.sources || [];
    let html = `<div class="pack-detail-page">
      <div style="margin-bottom:20px;">
        <div style="font-size:24px;font-weight:700;">üì¶ ${esc(p.name)}</div>
        ${p.description ? `<div style="font-size:14px;color:#888;margin-top:8px;">${esc(p.description)}</div>` : ''}
        <div class="pack-meta" style="margin-top:12px;">
          ${p.creator_avatar ? `<img src="${p.creator_avatar}" style="width:24px;height:24px;border-radius:50%;" alt="">` : ''}
          <span>${t('packBy')} ${p.creator_name || 'Anonymous'}</span>
          <span>¬∑</span>
          <span>${sources.length} ${t('packSources')}</span>
          <span>¬∑</span>
          <span>${p.install_count} ${t('packInstalls')}</span>
        </div>
      </div>
      <div style="margin-bottom:20px;">
        ${currentUser ? `<button class="pack-install-btn" onclick="installPack('${p.slug}', this)" style="padding:10px 28px;font-size:14px;border-radius:8px;">${t('installPack')}</button>` : `<a class="auth-btn" href="${API}/auth/google?origin=${encodeURIComponent(location.origin)}" style="padding:10px 28px;font-size:14px;">${t('loginToInstall')}</a>`}
      </div>
      <div style="font-size:14px;font-weight:600;margin-bottom:8px;">${t('packSources')} (${sources.length})</div>
      <div class="pack-detail-sources">
        ${sources.map(s => `<div class="pack-detail-source">
          <span class="icon">${SOURCE_ICONS[s.type] || 'üì¶'}</span>
          <div class="info"><div class="name">${esc(s.name)}</div><div class="type">${s.type}</div></div>
        </div>`).join('')}
      </div>
    </div>`;
    list.innerHTML = html;
  } catch (e) {
    list.innerHTML = `<div class="empty">Failed: ${e.message}</div>`;
  }
}

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelector('.tab.active')?.classList.remove('active');
    tab.classList.add('active');
    currentType = tab.dataset.type;
    currentOffset = 0; allLoaded = false;
    location.hash = currentType;
    document.getElementById('viewer').style.display = 'none';
    renderList();
  };
});

if (location.hash) {
  const h = location.hash.substring(1);
  if (['4h','daily','weekly','monthly','marks','sources'].includes(h)) {
    currentType = h;
    document.querySelector('.tab.active')?.classList.remove('active');
    const t = document.querySelector('.tab[data-type="'+h+'"]');
    if (t) t.classList.add('active');
  } else if (h.startsWith('pack/')) {
    currentPackSlug = h.slice(5);
  }
}

document.addEventListener('click', (e) => {
  document.querySelectorAll('.user-dropdown.show').forEach(dd => {
    if (!e.target.closest('.user-menu')) dd.classList.remove('show');
  });
});
applyLang();
// Detect /pack/:slug URL
const packPageMatch = location.pathname.match(/\/pack\/([a-z0-9_-]+)/);
checkAuth().then(() => {
  if (packPageMatch) {
    renderPackDetailPage(packPageMatch[1]);
  } else if (currentPackSlug) {
    renderPackDetailPage(currentPackSlug);
  } else {
    renderList();
  }
});
</script>
</body>
</html>
